<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReleaseService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Ma Banque Tools API</a> &gt; <a href="index.source.html" class="el_package">com.catsbanque.mabanquetools.service</a> &gt; <span class="el_source">ReleaseService.java</span></div><h1>ReleaseService.java</h1><pre class="source lang-java linenums">package com.catsbanque.mabanquetools.service;

import com.catsbanque.mabanquetools.dto.UpdateReleaseRequest;
import com.catsbanque.mabanquetools.dto.CreateReleaseRequest;
import com.catsbanque.mabanquetools.dto.ReleaseDto;
import com.catsbanque.mabanquetools.entity.Release;
import com.catsbanque.mabanquetools.entity.Squad;
import com.catsbanque.mabanquetools.exception.ResourceNotFoundException;
import com.catsbanque.mabanquetools.repository.ReleaseRepository;
import jakarta.annotation.PostConstruct;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.server.ResponseStatusException;

import java.time.LocalDateTime;
import java.time.ZonedDateTime;
import java.time.format.DateTimeParseException;
import java.util.ArrayList;
import java.util.List;
import java.util.stream.Collectors;

/**
 * Service de gestion des releases
 * Référence: release.controller.js
 */
<span class="fc" id="L29">@Slf4j</span>
@Service
@RequiredArgsConstructor
public class ReleaseService {

    private final ReleaseRepository releaseRepository;

    /**
     * Migration automatique des slugs pour les releases existantes
     * Exécuté au démarrage de l'application
     */
    /**
     * Migration automatique des slugs pour les releases existantes
     * Exécuté au démarrage de l'application par DataInitializer
     */
    @Transactional
    public void migrateSlugs() {
<span class="fc" id="L46">        List&lt;Release&gt; releasesWithoutSlug = releaseRepository.findAll().stream()</span>
<span class="pc bpc" id="L47" title="1 of 4 branches missed.">                .filter(r -&gt; r.getSlug() == null || r.getSlug().isEmpty())</span>
<span class="fc" id="L48">                .collect(Collectors.toList());</span>

<span class="fc bfc" id="L50" title="All 2 branches covered.">        if (!releasesWithoutSlug.isEmpty()) {</span>
<span class="fc" id="L51">            log.info(&quot;Migration des slugs: {} releases sans slug trouvées&quot;, releasesWithoutSlug.size());</span>

<span class="fc bfc" id="L53" title="All 2 branches covered.">            for (Release release : releasesWithoutSlug) {</span>
                // Le slug sera généré automatiquement par @PreUpdate
<span class="fc" id="L55">                release.setUpdatedAt(LocalDateTime.now());</span>
<span class="fc" id="L56">                releaseRepository.save(release);</span>
<span class="fc" id="L57">                log.debug(&quot;Slug généré pour release: {} -&gt; {}&quot;, release.getName(), release.getSlug());</span>
<span class="fc" id="L58">            }</span>

<span class="fc" id="L60">            log.info(&quot;Migration des slugs terminée: {} slugs générés&quot;, releasesWithoutSlug.size());</span>
        }
<span class="fc" id="L62">    }</span>

    /**
     * Récupérer toutes les releases (futures + 20 dernières passées)
     * Référence: release.controller.js:75-152
     *
     * Note: L'archivage automatique a été déplacé vers ArchiveScheduler (tâche
     * planifiée à 3h)
     * pour éviter de bloquer les requêtes GET avec des DELETE synchrones (cascade
     * sur Squads/Features/Actions)
     */
    @Transactional(readOnly = true)
    public List&lt;ReleaseDto&gt; getAllReleases() {
        // Archivage automatique → Déplacé vers ArchiveScheduler.archivePastReleases()

<span class="fc" id="L77">        LocalDateTime now = LocalDateTime.now();</span>

        // Récupérer toutes les releases à venir
<span class="fc" id="L80">        List&lt;Release&gt; upcomingReleases = releaseRepository.findByReleaseDateAfter(now);</span>

        // Récupérer les 20 dernières releases passées
<span class="fc" id="L83">        List&lt;Release&gt; pastReleases = releaseRepository</span>
<span class="fc" id="L84">                .findTop20ByReleaseDateBeforeOrderByReleaseDateDesc(now);</span>

        // Combiner les releases
<span class="fc" id="L87">        List&lt;Release&gt; allReleases = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L88">        allReleases.addAll(upcomingReleases);</span>
<span class="fc" id="L89">        allReleases.addAll(pastReleases);</span>

<span class="fc" id="L91">        return allReleases.stream()</span>
<span class="fc" id="L92">                .map(ReleaseDto::fromEntity)</span>
<span class="fc" id="L93">                .collect(Collectors.toList());</span>
    }

    /**
     * Récupérer une release par ID ou slug
     * Référence: release.controller.js:155-217
     */
    @Transactional(readOnly = true)
    public ReleaseDto getReleaseById(String identifier) {
        // Essayer d'abord par slug, puis par ID (rétrocompatibilité)
<span class="fc" id="L103">        Release release = releaseRepository.findBySlug(identifier)</span>
<span class="fc" id="L104">                .or(() -&gt; releaseRepository.findById(identifier))</span>
<span class="fc" id="L105">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Release not found&quot;));</span>

        // Force le chargement des squads (eager loading)
<span class="fc" id="L108">        release.getSquads().size();</span>

<span class="fc" id="L110">        return ReleaseDto.fromEntity(release);</span>
    }

    /**
     * Créer une nouvelle release avec 6 squads par défaut
     * Référence: release.controller.js:220-267
     */
    @Transactional
    public ReleaseDto createRelease(CreateReleaseRequest request) {
<span class="fc" id="L119">        Release release = new Release();</span>
<span class="fc" id="L120">        release.setName(request.getName());</span>
<span class="fc" id="L121">        release.setReleaseDate(parseReleaseDate(request.getReleaseDate()));</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">        release.setType(request.getType() != null ? request.getType() : &quot;release&quot;);</span>
<span class="fc" id="L123">        release.setDescription(request.getDescription());</span>
<span class="fc" id="L124">        release.setStatus(&quot;draft&quot;);</span>

        // Créer 6 squads par défaut
<span class="fc" id="L127">        List&lt;Squad&gt; squads = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">        for (int i = 1; i &lt;= 6; i++) {</span>
<span class="fc" id="L129">            Squad squad = new Squad();</span>
<span class="fc" id="L130">            squad.setSquadNumber(i);</span>
<span class="fc" id="L131">            squad.setIsCompleted(false);</span>
<span class="fc" id="L132">            squad.setFeaturesEmptyConfirmed(false);</span>
<span class="fc" id="L133">            squad.setPreMepEmptyConfirmed(false);</span>
<span class="fc" id="L134">            squad.setPostMepEmptyConfirmed(false);</span>
<span class="fc" id="L135">            squad.setRelease(release);</span>
<span class="fc" id="L136">            squads.add(squad);</span>
        }
<span class="fc" id="L138">        release.setSquads(squads);</span>

<span class="fc" id="L140">        Release saved = releaseRepository.save(release);</span>
<span class="fc" id="L141">        log.info(&quot;Release created: {}&quot;, saved.getId());</span>
<span class="fc" id="L142">        return ReleaseDto.fromEntity(saved);</span>
    }

    /**
     * Mettre à jour une release
     * Référence: release.controller.js:270-306
     */
    @Transactional
    public ReleaseDto updateRelease(String identifier, UpdateReleaseRequest request) {
<span class="fc" id="L151">        Release release = releaseRepository.findBySlug(identifier)</span>
<span class="fc" id="L152">                .or(() -&gt; releaseRepository.findById(identifier))</span>
<span class="fc" id="L153">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Release not found&quot;));</span>

<span class="pc bpc" id="L155" title="2 of 4 branches missed.">        if (request.getName() != null &amp;&amp; !request.getName().isBlank()) {</span>
<span class="fc" id="L156">            release.setName(request.getName());</span>
            // Le slug sera automatiquement regénéré par @PreUpdate
        }

<span class="pc bpc" id="L160" title="1 of 4 branches missed.">        if (request.getReleaseDate() != null &amp;&amp; !request.getReleaseDate().isBlank()) {</span>
<span class="fc" id="L161">            release.setReleaseDate(parseReleaseDate(request.getReleaseDate()));</span>
        }

<span class="fc bfc" id="L164" title="All 2 branches covered.">        if (request.getType() != null) {</span>
<span class="fc" id="L165">            release.setType(request.getType());</span>
        }

<span class="fc bfc" id="L168" title="All 2 branches covered.">        if (request.getDescription() != null) {</span>
<span class="fc" id="L169">            release.setDescription(request.getDescription());</span>
        }

<span class="fc bfc" id="L172" title="All 2 branches covered.">        if (request.getStatus() != null) {</span>
<span class="fc" id="L173">            release.setStatus(request.getStatus());</span>
        }

<span class="fc" id="L176">        Release updated = releaseRepository.save(release);</span>
<span class="fc" id="L177">        log.info(&quot;Release updated: {}&quot;, updated.getId());</span>
<span class="fc" id="L178">        return ReleaseDto.fromEntity(updated);</span>
    }

    /**
     * Mettre à jour le statut d'une release
     * Référence: release.controller.js:309-329
     */
    @Transactional
    public ReleaseDto updateReleaseStatus(String identifier, String status) {
<span class="fc" id="L187">        Release release = releaseRepository.findBySlug(identifier)</span>
<span class="fc" id="L188">                .or(() -&gt; releaseRepository.findById(identifier))</span>
<span class="pc" id="L189">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Release not found&quot;));</span>

<span class="fc" id="L191">        release.setStatus(status);</span>
<span class="fc" id="L192">        Release updated = releaseRepository.save(release);</span>
<span class="fc" id="L193">        log.info(&quot;Release status updated: {} -&gt; {}&quot;, updated.getId(), status);</span>
<span class="fc" id="L194">        return ReleaseDto.fromEntity(updated);</span>
    }

    /**
     * Supprimer une release
     * Référence: release.controller.js:332-345
     */
    @Transactional
    public void deleteRelease(String identifier) {
        // Accepter slug ou ID
<span class="fc" id="L204">        Release release = releaseRepository.findBySlug(identifier)</span>
<span class="fc" id="L205">                .or(() -&gt; releaseRepository.findById(identifier))</span>
<span class="fc" id="L206">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Release not found&quot;));</span>

<span class="fc" id="L208">        releaseRepository.delete(release);</span>
<span class="fc" id="L209">        log.info(&quot;Release deleted: {}&quot;, identifier);</span>
<span class="fc" id="L210">    }</span>

    /**
     * Parse une date string en LocalDateTime.
     * Supporte les formats:
     * - ISO 8601 avec timezone: &quot;2025-01-15T10:00:00.000Z&quot;
     * - ISO sans timezone: &quot;2025-01-15T10:00:00&quot;
     * - Date seule: &quot;2025-01-15&quot; (heure mise à 00:00)
     */
    private LocalDateTime parseReleaseDate(String dateString) {
<span class="pc bpc" id="L220" title="2 of 4 branches missed.">        if (dateString == null || dateString.isEmpty()) {</span>
<span class="nc" id="L221">            throw new IllegalArgumentException(&quot;Release date cannot be null or empty&quot;);</span>
        }

        try {
            // Essayer de parser comme ISO 8601 avec timezone (ex: 2025-01-15T10:00:00.000Z)
<span class="pc bpc" id="L226" title="1 of 4 branches missed.">            if (dateString.contains(&quot;Z&quot;) || dateString.contains(&quot;+&quot;)) {</span>
<span class="fc" id="L227">                return ZonedDateTime.parse(dateString).toLocalDateTime();</span>
            }

            // Essayer de parser comme LocalDateTime (ex: 2025-01-15T10:00:00)
<span class="fc bfc" id="L231" title="All 2 branches covered.">            if (dateString.contains(&quot;T&quot;)) {</span>
<span class="fc" id="L232">                return LocalDateTime.parse(dateString);</span>
            }

            // Parser comme LocalDate et convertir en LocalDateTime à minuit (ex:
            // 2025-01-15)
<span class="fc" id="L237">            return java.time.LocalDate.parse(dateString).atStartOfDay();</span>

<span class="fc" id="L239">        } catch (DateTimeParseException e) {</span>
<span class="fc" id="L240">            log.error(&quot;Erreur de parsing de la date: {}&quot;, dateString, e);</span>
<span class="fc" id="L241">            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, &quot;Format de date invalide: &quot; + dateString</span>
                    + &quot;. Formats acceptés: yyyy-MM-dd ou yyyy-MM-dd'T'HH:mm:ss&quot;, e);
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>