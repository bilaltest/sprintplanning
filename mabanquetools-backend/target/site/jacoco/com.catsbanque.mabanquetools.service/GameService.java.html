<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GameService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Ma Banque Tools API</a> &gt; <a href="index.source.html" class="el_package">com.catsbanque.mabanquetools.service</a> &gt; <span class="el_source">GameService.java</span></div><h1>GameService.java</h1><pre class="source lang-java linenums">package com.catsbanque.mabanquetools.service;

import com.catsbanque.mabanquetools.dto.LeaderboardEntry;
import com.catsbanque.mabanquetools.dto.LeaderboardUser;
import com.catsbanque.mabanquetools.dto.MyScoresResponse;
import com.catsbanque.mabanquetools.dto.SubmitScoreRequest;
import com.catsbanque.mabanquetools.dto.SubmitScoreResponse;
import com.catsbanque.mabanquetools.entity.Game;
import com.catsbanque.mabanquetools.entity.GameScore;
import com.catsbanque.mabanquetools.entity.User;
import com.catsbanque.mabanquetools.exception.BadRequestException;
import com.catsbanque.mabanquetools.exception.ResourceNotFoundException;
import com.catsbanque.mabanquetools.exception.UnauthorizedException;
import com.catsbanque.mabanquetools.repository.GameRepository;
import com.catsbanque.mabanquetools.repository.GameScoreRepository;
import com.catsbanque.mabanquetools.repository.UserRepository;
import jakarta.persistence.EntityManager;
import jakarta.persistence.Query;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.math.BigInteger;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Optional;

/**
 * Service de gestion des jeux
 * Référence: game.controller.js
 */
<span class="fc" id="L34">@Slf4j</span>
@Service
@RequiredArgsConstructor
public class GameService {

    private final GameRepository gameRepository;
    private final GameScoreRepository gameScoreRepository;
    private final UserRepository userRepository;
    private final EntityManager entityManager;

    /**
     * Récupérer tous les jeux actifs
     * Référence: game.controller.js:5-16
     */
    @Transactional(readOnly = true)
    public List&lt;Game&gt; getAllGames() {
<span class="fc" id="L50">        return gameRepository.findByIsActiveTrueOrderByCreatedAtAsc();</span>
    }

    /**
     * Récupérer un jeu par slug
     * Référence: game.controller.js:18-35
     */
    @Transactional(readOnly = true)
    public Game getGameBySlug(String slug) {
<span class="fc" id="L59">        return gameRepository.findBySlug(slug)</span>
<span class="fc" id="L60">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Game not found&quot;));</span>
    }

    /**
     * Récupérer le classement Top 10
     * Référence: game.controller.js:37-102
     */
    @Transactional(readOnly = true)
    public List&lt;LeaderboardEntry&gt; getLeaderboard(String slug) {
<span class="fc" id="L69">        Game game = gameRepository.findBySlug(slug)</span>
<span class="fc" id="L70">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Game not found&quot;));</span>

        // Query SQL native pour récupérer le meilleur score de chaque utilisateur (une
        // seule entrée par utilisateur)
<span class="fc" id="L74">        String sql = &quot;&quot;&quot;</span>
                SELECT
                    gs.id as id,
                    gs.game_id as gameId,
                    gs.user_id as userId,
                    gs.visitor_name as visitorName,
                    gs.score as score,
                    gs.wpm as wpm,
                    gs.accuracy as accuracy,
                    gs.created_at as createdAt,
                    u.first_name as firstName,
                    u.last_name as lastName,
                    u.email as email
                FROM game_score gs
                LEFT JOIN app_user u ON gs.user_id = u.id
                WHERE gs.game_id = :gameId
                AND gs.id = (
                    SELECT gs2.id
                    FROM game_score gs2
                    WHERE gs2.game_id = gs.game_id
                    AND (
                        (gs2.user_id IS NOT NULL AND gs2.user_id = gs.user_id)
                        OR (gs2.user_id IS NULL AND gs2.visitor_name = gs.visitor_name)
                    )
                    ORDER BY gs2.score DESC, gs2.created_at ASC
                    LIMIT 1
                )
                ORDER BY gs.score DESC, gs.created_at ASC
                LIMIT 10
                &quot;&quot;&quot;;

<span class="fc" id="L105">        Query query = entityManager.createNativeQuery(sql);</span>
<span class="fc" id="L106">        query.setParameter(&quot;gameId&quot;, game.getId());</span>

        @SuppressWarnings(&quot;unchecked&quot;)
<span class="fc" id="L109">        List&lt;Object[]&gt; results = query.getResultList();</span>

<span class="fc" id="L111">        List&lt;LeaderboardEntry&gt; leaderboard = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L112">        int rank = 1;</span>

<span class="fc bfc" id="L114" title="All 2 branches covered.">        for (Object[] row : results) {</span>
<span class="fc" id="L115">            LeaderboardEntry entry = new LeaderboardEntry();</span>
<span class="fc" id="L116">            entry.setId((String) row[0]);</span>
<span class="fc" id="L117">            entry.setRank(rank++);</span>
<span class="fc" id="L118">            entry.setScore((Integer) row[4]);</span>
<span class="fc" id="L119">            entry.setWpm((Integer) row[5]);</span>
<span class="fc" id="L120">            entry.setAccuracy((Double) row[6]);</span>

            // Convertir Timestamp en LocalDateTime
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">            if (row[7] != null) {</span>
<span class="fc" id="L124">                entry.setCreatedAt(((java.sql.Timestamp) row[7]).toLocalDateTime());</span>
            }

<span class="fc" id="L127">            entry.setUserId((String) row[2]);</span>
<span class="fc" id="L128">            entry.setVisitorName((String) row[3]);</span>

            // Si c'est un utilisateur authentifié
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">            if (row[2] != null) {</span>
<span class="fc" id="L132">                LeaderboardUser user = new LeaderboardUser();</span>
<span class="fc" id="L133">                user.setFirstName((String) row[8]);</span>
<span class="fc" id="L134">                user.setLastName((String) row[9]);</span>
<span class="fc" id="L135">                user.setEmail((String) row[10]);</span>
<span class="fc" id="L136">                entry.setUser(user);</span>
            }

<span class="fc" id="L139">            leaderboard.add(entry);</span>
<span class="fc" id="L140">        }</span>

<span class="fc" id="L142">        return leaderboard;</span>
    }

    /**
     * Soumettre un score
     * Référence: game.controller.js:104-184
     */
    @Transactional
    public SubmitScoreResponse submitScore(String slug, SubmitScoreRequest request, String userId) {
        // Valider le score
<span class="fc bfc" id="L152" title="All 4 branches covered.">        if (request.getScore() == null || request.getScore() &lt; 0) {</span>
<span class="fc" id="L153">            throw new BadRequestException(&quot;Invalid score&quot;);</span>
        }

        // Récupérer le jeu
<span class="fc" id="L157">        Game game = gameRepository.findBySlug(slug)</span>
<span class="fc" id="L158">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Game not found&quot;));</span>

<span class="fc bfc" id="L160" title="All 2 branches covered.">        if (userId == null) {</span>
<span class="fc" id="L161">            throw new UnauthorizedException(&quot;Authentication required&quot;);</span>
        }

        // Vérifier que l'utilisateur existe
<span class="fc" id="L165">        User user = userRepository.findById(userId)</span>
<span class="fc" id="L166">                .orElseThrow(() -&gt; new UnauthorizedException(&quot;User not found&quot;));</span>

        // Créer le score
<span class="fc" id="L169">        GameScore gameScore = new GameScore();</span>
<span class="fc" id="L170">        gameScore.setGameId(game.getId());</span>
<span class="fc" id="L171">        gameScore.setUserId(userId);</span>
<span class="fc" id="L172">        gameScore.setScore(request.getScore());</span>
<span class="fc" id="L173">        gameScore.setWpm(request.getWpm());</span>
<span class="fc" id="L174">        gameScore.setAccuracy(request.getAccuracy());</span>

<span class="pc bpc" id="L176" title="1 of 2 branches missed.">        if (request.getMetadata() != null) {</span>
            // Convert metadata to JSON string if needed
<span class="nc" id="L178">            gameScore.setMetadata(request.getMetadata().toString());</span>
        }

<span class="fc" id="L181">        gameScore = gameScoreRepository.save(gameScore);</span>

        // Récupérer le meilleur score de l'utilisateur
<span class="fc" id="L184">        Optional&lt;GameScore&gt; userBestScoreOpt = gameScoreRepository</span>
<span class="fc" id="L185">                .findFirstByGameIdAndUserIdOrderByScoreDesc(game.getId(), userId);</span>

<span class="fc" id="L187">        Integer bestScore = userBestScoreOpt.map(GameScore::getScore).orElse(0);</span>
<span class="fc" id="L188">        boolean isNewPersonalBest = request.getScore().equals(bestScore);</span>

        // Compter combien de joueurs ont un meilleur score
<span class="fc" id="L191">        String countSql = &quot;&quot;&quot;</span>
                SELECT COUNT(DISTINCT COALESCE(user_id, visitor_name)) as count
                FROM game_score
                WHERE game_id = :gameId
                AND score &gt; :bestScore
                &quot;&quot;&quot;;

<span class="fc" id="L198">        Query countQuery = entityManager.createNativeQuery(countSql);</span>
<span class="fc" id="L199">        countQuery.setParameter(&quot;gameId&quot;, game.getId());</span>
<span class="fc" id="L200">        countQuery.setParameter(&quot;bestScore&quot;, bestScore);</span>

<span class="fc" id="L202">        Object result = countQuery.getSingleResult();</span>
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">        long count = result instanceof BigInteger ? ((BigInteger) result).longValue() : ((Number) result).longValue();</span>
<span class="fc" id="L204">        int rank = (int) count + 1;</span>

        // Build response
<span class="fc" id="L207">        SubmitScoreResponse response = new SubmitScoreResponse();</span>
<span class="fc" id="L208">        response.setId(gameScore.getId());</span>
<span class="fc" id="L209">        response.setGameId(gameScore.getGameId());</span>
<span class="fc" id="L210">        response.setUserId(gameScore.getUserId());</span>
<span class="fc" id="L211">        response.setScore(gameScore.getScore());</span>
<span class="fc" id="L212">        response.setWpm(gameScore.getWpm());</span>
<span class="fc" id="L213">        response.setAccuracy(gameScore.getAccuracy());</span>
<span class="fc" id="L214">        response.setMetadata(gameScore.getMetadata());</span>
<span class="fc" id="L215">        response.setCreatedAt(gameScore.getCreatedAt());</span>
<span class="fc" id="L216">        response.setRank(rank);</span>
<span class="fc" id="L217">        response.setNewPersonalBest(isNewPersonalBest);</span>

        // Add user info
<span class="fc" id="L220">        LeaderboardUser userInfo = new LeaderboardUser();</span>
<span class="fc" id="L221">        userInfo.setFirstName(user.getFirstName());</span>
<span class="fc" id="L222">        userInfo.setLastName(user.getLastName());</span>
<span class="fc" id="L223">        userInfo.setEmail(user.getEmail());</span>
<span class="fc" id="L224">        response.setUser(userInfo);</span>

<span class="fc" id="L226">        log.info(&quot;Score submitted for game {} by user {}: {} (rank: {})&quot;, slug, userId, request.getScore(), rank);</span>

<span class="fc" id="L228">        return response;</span>
    }

    /**
     * Récupérer mes scores
     * Référence: game.controller.js:186-230
     */
    @Transactional(readOnly = true)
    public MyScoresResponse getMyScores(String slug, String userId) {
<span class="fc bfc" id="L237" title="All 2 branches covered.">        if (userId == null) {</span>
<span class="fc" id="L238">            throw new UnauthorizedException(&quot;Authentication required&quot;);</span>
        }

<span class="fc" id="L241">        Game game = gameRepository.findBySlug(slug)</span>
<span class="fc" id="L242">                .orElseThrow(() -&gt; new ResourceNotFoundException(&quot;Game not found&quot;));</span>

        // Récupérer les 10 derniers scores
<span class="fc" id="L245">        List&lt;GameScore&gt; scores = gameScoreRepository</span>
<span class="fc" id="L246">                .findTop10ByGameIdAndUserIdOrderByCreatedAtDesc(game.getId(), userId);</span>

        // Récupérer le meilleur score
<span class="fc" id="L249">        Optional&lt;GameScore&gt; bestScoreOpt = gameScoreRepository</span>
<span class="fc" id="L250">                .findFirstByGameIdAndUserIdOrderByScoreDesc(game.getId(), userId);</span>

<span class="fc" id="L252">        int bestScore = bestScoreOpt.map(GameScore::getScore).orElse(0);</span>
<span class="fc" id="L253">        int gamesPlayed = scores.size();</span>

<span class="fc" id="L255">        MyScoresResponse response = new MyScoresResponse();</span>
<span class="fc" id="L256">        response.setScores(scores);</span>
<span class="fc" id="L257">        response.setBestScore(bestScore);</span>
<span class="fc" id="L258">        response.setGamesPlayed(gamesPlayed);</span>

<span class="fc" id="L260">        return response;</span>
    }

    /**
     * Initialiser les jeux par défaut
     * Référence: game.controller.js:232-281
     */
    @Transactional
    public List&lt;Game&gt; initGames() {
<span class="fc" id="L269">        List&lt;GameInitData&gt; gamesData = Arrays.asList(</span>
                new GameInitData(&quot;typing-fr&quot;, &quot;Typing Challenge FR&quot;,
                        &quot;Tapez un maximum de mots en français en 60 secondes !&quot;, &quot;keyboard&quot;),
                new GameInitData(&quot;typing-en&quot;, &quot;Typing Challenge EN&quot;,
                        &quot;Type as many English words as you can in 60 seconds!&quot;, &quot;keyboard&quot;),
                new GameInitData(&quot;memory-game&quot;, &quot;Memory Game&quot;,
                        &quot;Trouvez toutes les paires de cartes le plus vite possible !&quot;, &quot;psychology&quot;),
                new GameInitData(&quot;math-rush&quot;, &quot;Math Rush&quot;,
                        &quot;Résolvez un maximum de calculs en 60 secondes !&quot;, &quot;calculate&quot;),
                new GameInitData(&quot;flappy-dsi&quot;, &quot;Flappy DSI&quot;,
                        &quot;Évitez les obstacles de la DSI et battez vos collègues !&quot;, &quot;flight&quot;));

<span class="fc bfc" id="L281" title="All 2 branches covered.">        for (GameInitData data : gamesData) {</span>
<span class="fc" id="L282">            Optional&lt;Game&gt; existingGame = gameRepository.findBySlug(data.slug());</span>

<span class="fc bfc" id="L284" title="All 2 branches covered.">            if (existingGame.isPresent()) {</span>
                // Update
<span class="fc" id="L286">                Game game = existingGame.get();</span>
<span class="fc" id="L287">                game.setName(data.name());</span>
<span class="fc" id="L288">                game.setDescription(data.description());</span>
<span class="fc" id="L289">                game.setIcon(data.icon());</span>
<span class="fc" id="L290">                gameRepository.save(game);</span>
<span class="fc" id="L291">            } else {</span>
                // Create
<span class="fc" id="L293">                Game game = new Game();</span>
<span class="fc" id="L294">                game.setSlug(data.slug());</span>
<span class="fc" id="L295">                game.setName(data.name());</span>
<span class="fc" id="L296">                game.setDescription(data.description());</span>
<span class="fc" id="L297">                game.setIcon(data.icon());</span>
<span class="fc" id="L298">                game.setIsActive(true);</span>
<span class="fc" id="L299">                gameRepository.save(game);</span>
            }
<span class="fc" id="L301">        }</span>

<span class="fc" id="L303">        log.info(&quot;Initialized {} games&quot;, gamesData.size());</span>

<span class="fc" id="L305">        return gameRepository.findAll();</span>
    }

    /**
     * Inner class for game initialization data
     */
<span class="fc" id="L311">    private record GameInitData(String slug, String name, String description, String icon) {</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>