<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Ma Banque Tools API</a> &gt; <a href="index.source.html" class="el_package">com.catsbanque.mabanquetools.service</a> &gt; <span class="el_source">AuthService.java</span></div><h1>AuthService.java</h1><pre class="source lang-java linenums">package com.catsbanque.mabanquetools.service;

import com.catsbanque.mabanquetools.dto.AuthResponse;
import com.catsbanque.mabanquetools.dto.LoginRequest;
import com.catsbanque.mabanquetools.dto.RegisterRequest;
import com.catsbanque.mabanquetools.dto.UserDto;
import com.catsbanque.mabanquetools.entity.PermissionLevel;
import com.catsbanque.mabanquetools.entity.PermissionModule;
import com.catsbanque.mabanquetools.entity.User;
import com.catsbanque.mabanquetools.exception.BadRequestException;
import com.catsbanque.mabanquetools.repository.UserRepository;
import com.catsbanque.mabanquetools.util.JwtUtil;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import tools.jackson.core.JacksonException;

import java.util.Arrays;
import java.util.Map;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

/**
 * Service d'authentification identique à Node.js (auth.controller.js)
 */
<span class="fc" id="L28">@Slf4j</span>
@Service
@RequiredArgsConstructor
public class AuthService {

    private final UserRepository userRepository;
    private final PasswordEncoder passwordEncoder;
    private final JwtUtil jwtUtil;
    private final PermissionService permissionService;

    // Pattern email: prenom.nom@ca-ts.fr ou prenom.nom-ext@ca-ts.fr
<span class="fc" id="L39">    private static final Pattern EMAIL_PATTERN = Pattern.compile(&quot;^[a-z]+\\.[a-z]+(-ext)?@ca-ts\\.fr$&quot;,</span>
            Pattern.CASE_INSENSITIVE);

    private static final int MAX_USERS = 200;

    /**
     * Enregistrement d'un nouvel utilisateur
     * Référence: auth.controller.js:84-146
     */
    @Transactional
    public AuthResponse register(RegisterRequest request) {
<span class="fc" id="L50">        String email = request.getEmail().toLowerCase();</span>
<span class="fc" id="L51">        String password = request.getPassword();</span>

<span class="fc" id="L53">        log.info(&quot;Tentative d'enregistrement pour: {}&quot;, email);</span>

        // Validation email (auth.controller.js:89-93)
<span class="fc bfc" id="L56" title="All 4 branches covered.">        if (!&quot;admin&quot;.equals(email) &amp;&amp; !EMAIL_PATTERN.matcher(email).matches()) {</span>
<span class="fc" id="L57">            throw new BadRequestException(</span>
                    &quot;L'adresse email doit être au format prenom.nom@ca-ts.fr ou prenom.nom-ext@ca-ts.fr&quot;);
        }

        // Validation mot de passe (auth.controller.js:96-99)
<span class="fc" id="L62">        validatePassword(password);</span>

        // Vérification existence (auth.controller.js:102-108)
<span class="fc bfc" id="L65" title="All 2 branches covered.">        if (userRepository.existsByEmail(email)) {</span>
<span class="fc" id="L66">            throw new BadRequestException(&quot;Un compte existe déjà avec cette adresse email&quot;);</span>
        }

        // Limite 200 users (auth.controller.js:111-116)
<span class="fc" id="L70">        long userCount = userRepository.count();</span>
<span class="fc bfc" id="L71" title="All 2 branches covered.">        if (userCount &gt;= MAX_USERS) {</span>
<span class="fc" id="L72">            throw new BadRequestException(</span>
                    &quot;Limite d'utilisateurs atteinte (200 max). Veuillez contacter l'administrateur.&quot;);
        }

        // Extraction prénom/nom (auth.controller.js:119)
<span class="fc" id="L77">        NamePair names = extractNameFromEmail(email);</span>

        // Hash password avec BCrypt coût 10 (auth.controller.js:122)
<span class="fc" id="L80">        String hashedPassword = passwordEncoder.encode(password);</span>

        // Créer utilisateur (auth.controller.js:125-132)
<span class="fc" id="L83">        User user = new User();</span>
<span class="fc" id="L84">        user.setEmail(email);</span>
<span class="fc" id="L85">        user.setPassword(hashedPassword);</span>
<span class="fc" id="L86">        user.setFirstName(names.firstName);</span>
<span class="fc" id="L87">        user.setLastName(names.lastName);</span>
<span class="fc" id="L88">        user.setThemePreference(&quot;light&quot;);</span>
<span class="fc" id="L89">        user.setWidgetOrder(&quot;[]&quot;);</span>

<span class="fc" id="L91">        User saved = userRepository.save(user);</span>
<span class="fc" id="L92">        log.info(&quot;Utilisateur créé avec succès: {}&quot;, saved.getId());</span>

        // Créer les permissions par défaut
<span class="fc" id="L95">        permissionService.createDefaultPermissions(saved);</span>

        // Charger les permissions pour la réponse
<span class="fc" id="L98">        Map&lt;PermissionModule, PermissionLevel&gt; permissions = permissionService.getUserPermissions(saved.getId());</span>

        // Générer le token JWT
<span class="fc" id="L101">        String jwtToken = jwtUtil.generateToken(saved.getId(), saved.getEmail(), saved.getFirstName(),</span>
<span class="fc" id="L102">                saved.getLastName());</span>

<span class="fc" id="L104">        return AuthResponse.builder()</span>
<span class="fc" id="L105">                .message(&quot;Compte créé avec succès&quot;)</span>
<span class="fc" id="L106">                .token(jwtToken)</span>
<span class="fc" id="L107">                .user(UserDto.fromEntityWithPermissions(saved, permissions))</span>
<span class="fc" id="L108">                .build();</span>
    }

    /**
     * Connexion d'un utilisateur
     * Référence: auth.controller.js:151-180
     */
    @Transactional(readOnly = true)
    public AuthResponse login(LoginRequest request) {
        // Validation (auth.controller.js:156-158)
<span class="pc bpc" id="L118" title="1 of 4 branches missed.">        if (request.getEmail() == null || request.getPassword() == null) {</span>
<span class="fc" id="L119">            throw new BadRequestException(&quot;Email et mot de passe requis&quot;);</span>
        }

<span class="fc" id="L122">        String email = request.getEmail().toLowerCase();</span>
<span class="fc" id="L123">        String password = request.getPassword();</span>

<span class="fc" id="L125">        log.info(&quot;Tentative de connexion pour: {}&quot;, email);</span>

        // Trouver utilisateur (auth.controller.js:161-163)
<span class="fc" id="L128">        User user = userRepository.findByEmail(email)</span>
<span class="fc" id="L129">                .orElseThrow(() -&gt; new BadRequestException(&quot;Email ou mot de passe incorrect&quot;));</span>

        // Vérifier password (auth.controller.js:170-174)
<span class="fc bfc" id="L132" title="All 2 branches covered.">        if (!passwordEncoder.matches(password, user.getPassword())) {</span>
<span class="fc" id="L133">            throw new BadRequestException(&quot;Email ou mot de passe incorrect&quot;);</span>
        }

        // Charger les permissions de l'utilisateur
<span class="fc" id="L137">        Map&lt;PermissionModule, PermissionLevel&gt; permissions = permissionService.getUserPermissions(user.getId());</span>

        // Générer token JWT
<span class="fc" id="L140">        String jwtToken = jwtUtil.generateToken(user.getId(), user.getEmail(), user.getFirstName(), user.getLastName());</span>

<span class="fc" id="L142">        log.info(&quot;Connexion réussie pour: {}&quot;, email);</span>

<span class="fc" id="L144">        return AuthResponse.builder()</span>
<span class="fc" id="L145">                .message(&quot;Connexion réussie&quot;)</span>
<span class="fc" id="L146">                .token(jwtToken)</span>
<span class="fc" id="L147">                .user(UserDto.fromEntityWithPermissions(user, permissions))</span>
<span class="fc" id="L148">                .build();</span>
    }

    /**
     * Récupère l'utilisateur courant avec ses permissions
     * Référence: auth.controller.js:185-213
     */
    @Transactional(readOnly = true)
    public UserDto getCurrentUser(String userId) {
<span class="nc" id="L157">        log.info(&quot;Récupération de l'utilisateur: {}&quot;, userId);</span>

        // Trouver utilisateur (auth.controller.js:197-199)
<span class="nc" id="L160">        User user = userRepository.findById(userId)</span>
<span class="nc" id="L161">                .orElseThrow(() -&gt; new com.catsbanque.mabanquetools.exception.ResourceNotFoundException(</span>
                        &quot;Utilisateur non trouvé&quot;));

        // Charger les permissions
<span class="nc" id="L165">        Map&lt;PermissionModule, PermissionLevel&gt; permissions = permissionService.getUserPermissions(userId);</span>

        // Retourner sans le mot de passe (auth.controller.js:202-203)
<span class="nc" id="L168">        return UserDto.fromEntityWithPermissions(user, permissions);</span>
    }

    /**
     * Met à jour les préférences utilisateur (thème)
     */
    @Transactional
    public UserDto updatePreferences(String userId, String themePreference) {
<span class="nc" id="L176">        log.info(&quot;Mise à jour des préférences pour l'utilisateur {}: theme={}&quot;, userId, themePreference);</span>

        // Trouver utilisateur
<span class="nc" id="L179">        User user = userRepository.findById(userId)</span>
<span class="nc" id="L180">                .orElseThrow(() -&gt; new com.catsbanque.mabanquetools.exception.ResourceNotFoundException(</span>
                        &quot;Utilisateur non trouvé&quot;));

        // Mettre à jour le thème
<span class="nc" id="L184">        user.setThemePreference(themePreference);</span>
<span class="nc" id="L185">        User updated = userRepository.save(user);</span>

        // Charger les permissions
<span class="nc" id="L188">        Map&lt;PermissionModule, PermissionLevel&gt; permissions = permissionService.getUserPermissions(userId);</span>

        // Retourner l'utilisateur mis à jour avec ses permissions
<span class="nc" id="L191">        return UserDto.fromEntityWithPermissions(updated, permissions);</span>
    }

    /**
     * Met à jour l'ordre des widgets sur la home pour l'utilisateur
     * Référence: auth.controller.js:288-329
     */
    @Transactional
    public UserDto updateWidgetOrder(String userId, java.util.List&lt;String&gt; widgetOrder) {
<span class="nc" id="L200">        log.info(&quot;Mise à jour de l'ordre des widgets pour l'utilisateur {}: {}&quot;, userId, widgetOrder);</span>

        // Trouver utilisateur
<span class="nc" id="L203">        User user = userRepository.findById(userId)</span>
<span class="nc" id="L204">                .orElseThrow(() -&gt; new com.catsbanque.mabanquetools.exception.ResourceNotFoundException(</span>
                        &quot;Utilisateur non trouvé&quot;));

        // Validation: vérifier que tous les IDs sont des strings
        // (auth.controller.js:304-307)
<span class="nc bnc" id="L209" title="All 4 branches missed.">        if (widgetOrder.stream().anyMatch(id -&gt; !(id instanceof String))) {</span>
<span class="nc" id="L210">            throw new BadRequestException(&quot;Les IDs des widgets doivent être des strings&quot;);</span>
        }

        // Convertir la liste en JSON string (auth.controller.js:310-315)
        String widgetOrderJson;
        try {
<span class="nc" id="L216">            widgetOrderJson = new tools.jackson.databind.ObjectMapper().writeValueAsString(widgetOrder);</span>
<span class="nc" id="L217">        } catch (JacksonException e) {</span>
<span class="nc" id="L218">            throw new BadRequestException(&quot;Erreur lors de la sérialisation de widgetOrder&quot;);</span>
<span class="nc" id="L219">        }</span>

        // Mettre à jour l'ordre des widgets
<span class="nc" id="L222">        user.setWidgetOrder(widgetOrderJson);</span>
<span class="nc" id="L223">        User updated = userRepository.save(user);</span>

        // Charger les permissions
<span class="nc" id="L226">        Map&lt;PermissionModule, PermissionLevel&gt; permissions = permissionService.getUserPermissions(userId);</span>

<span class="nc" id="L228">        log.info(&quot;Ordre des widgets mis à jour avec succès pour l'utilisateur {}&quot;, userId);</span>

        // Retourner l'utilisateur mis à jour avec ses permissions
        // (auth.controller.js:318-323)
<span class="nc" id="L232">        return UserDto.fromEntityWithPermissions(updated, permissions);</span>
    }

    /**
     * Validation du mot de passe
     * Référence: auth.controller.js:44-78
     */
    private void validatePassword(String password) {
<span class="fc bfc" id="L240" title="All 2 branches covered.">        if (password.length() &lt; 8) {</span>
<span class="fc" id="L241">            throw new BadRequestException(&quot;Le mot de passe doit contenir au moins 8 caractères&quot;);</span>
        }

<span class="fc" id="L244">        boolean hasLetter = password.matches(&quot;.*[a-zA-Z].*&quot;);</span>
<span class="fc" id="L245">        boolean hasNumber = password.matches(&quot;.*[0-9].*&quot;);</span>
<span class="fc" id="L246">        boolean isAlphanumeric = password.matches(&quot;^[a-zA-Z0-9]+$&quot;);</span>

<span class="fc bfc" id="L248" title="All 2 branches covered.">        if (!isAlphanumeric) {</span>
<span class="fc" id="L249">            throw new BadRequestException(</span>
                    &quot;Le mot de passe doit être alphanumérique (lettres et chiffres uniquement)&quot;);
        }

<span class="pc bpc" id="L253" title="1 of 4 branches missed.">        if (!hasLetter || !hasNumber) {</span>
<span class="fc" id="L254">            throw new BadRequestException(</span>
                    &quot;Le mot de passe doit contenir au moins une lettre et un chiffre&quot;);
        }
<span class="fc" id="L257">    }</span>

    /**
     * Extraction du prénom et nom depuis l'email
     * Référence: auth.controller.js:11-40
     */
    private NamePair extractNameFromEmail(String email) {
        // Cas spécial admin (auth.controller.js:13-17)
<span class="fc bfc" id="L265" title="All 2 branches covered.">        if (&quot;admin&quot;.equalsIgnoreCase(email)) {</span>
<span class="fc" id="L266">            return new NamePair(&quot;Admin&quot;, &quot;System&quot;);</span>
        }

        // Extraction prenom.nom (auth.controller.js:20-40)
<span class="fc" id="L270">        String localPart = email.split(&quot;@&quot;)[0];</span>
<span class="fc" id="L271">        String namePart = localPart.replaceAll(&quot;-ext$&quot;, &quot;&quot;);</span>
<span class="fc" id="L272">        String[] parts = namePart.split(&quot;\\.&quot;);</span>

<span class="pc bpc" id="L274" title="1 of 2 branches missed.">        if (parts.length &gt;= 2) {</span>
<span class="fc" id="L275">            String firstName = capitalize(parts[0]);</span>
<span class="fc" id="L276">            String lastName = Arrays.stream(parts, 1, parts.length)</span>
<span class="fc" id="L277">                    .map(String::toUpperCase)</span>
<span class="fc" id="L278">                    .collect(Collectors.joining(&quot; &quot;));</span>
<span class="fc" id="L279">            return new NamePair(firstName, lastName);</span>
        }

<span class="nc" id="L282">        return new NamePair(capitalize(parts[0]), &quot;&quot;);</span>
    }

    /**
     * Capitalise la première lettre d'une chaîne
     */
    private String capitalize(String str) {
<span class="pc bpc" id="L289" title="2 of 4 branches missed.">        if (str == null || str.isEmpty()) {</span>
<span class="nc" id="L290">            return str;</span>
        }
<span class="fc" id="L292">        return str.substring(0, 1).toUpperCase() + str.substring(1).toLowerCase();</span>
    }

    /**
     * Record pour stocker le prénom et nom
     */
<span class="fc" id="L298">    private record NamePair(String firstName, String lastName) {</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>