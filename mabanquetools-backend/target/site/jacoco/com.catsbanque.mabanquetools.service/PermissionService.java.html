<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PermissionService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Ma Banque Tools API</a> &gt; <a href="index.source.html" class="el_package">com.catsbanque.mabanquetools.service</a> &gt; <span class="el_source">PermissionService.java</span></div><h1>PermissionService.java</h1><pre class="source lang-java linenums">package com.catsbanque.mabanquetools.service;

import com.catsbanque.mabanquetools.entity.PermissionLevel;
import com.catsbanque.mabanquetools.entity.PermissionModule;
import com.catsbanque.mabanquetools.entity.User;
import com.catsbanque.mabanquetools.entity.UserPermission;
import com.catsbanque.mabanquetools.repository.UserPermissionRepository;
import com.catsbanque.mabanquetools.repository.UserRepository;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * Service de gestion des permissions utilisateurs.
 *
 * Responsabilités:
 * - Vérifier les accès READ/WRITE sur les modules
 * - Créer les permissions par défaut lors de l'inscription
 * - Mettre à jour les permissions (admin uniquement)
 */
@Service
@RequiredArgsConstructor
<span class="fc" id="L28">@Slf4j</span>
public class PermissionService {

    private final UserPermissionRepository permissionRepository;
    private final UserRepository userRepository;

    /**
     * Récupère toutes les permissions d'un utilisateur sous forme de Map.
     *
     * @param userId l'ID de l'utilisateur
     * @return Map&lt;Module, Level&gt;
     */
    public Map&lt;PermissionModule, PermissionLevel&gt; getUserPermissions(String userId) {
<span class="fc" id="L41">        List&lt;UserPermission&gt; permissions = permissionRepository.findByUserId(userId);</span>

<span class="fc" id="L43">        Map&lt;PermissionModule, PermissionLevel&gt; permissionsMap = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L44" title="All 2 branches covered.">        for (UserPermission permission : permissions) {</span>
<span class="fc" id="L45">            permissionsMap.put(permission.getModule(), permission.getPermissionLevel());</span>
<span class="fc" id="L46">        }</span>

        // Si aucune permission n'existe (cas anormal), retourner des permissions vides
<span class="fc bfc" id="L49" title="All 2 branches covered.">        if (permissionsMap.isEmpty()) {</span>
<span class="fc" id="L50">            log.warn(&quot;Aucune permission trouvée pour l'utilisateur {}&quot;, userId);</span>
<span class="fc" id="L51">            return getDefaultPermissions();</span>
        }

<span class="fc" id="L54">        return permissionsMap;</span>
    }

    /**
     * Vérifie si un utilisateur a accès en LECTURE (READ ou WRITE) à un module.
     *
     * @param userId l'ID de l'utilisateur
     * @param module le module à vérifier
     * @return true si accès READ ou WRITE, false sinon
     */
    public boolean hasReadAccess(String userId, PermissionModule module) {
<span class="fc" id="L65">        PermissionLevel level = getPermissionLevel(userId, module);</span>
<span class="fc bfc" id="L66" title="All 4 branches covered.">        return level == PermissionLevel.READ || level == PermissionLevel.WRITE;</span>
    }

    /**
     * Vérifie si un utilisateur a accès en ÉCRITURE (WRITE uniquement) à un module.
     *
     * @param userId l'ID de l'utilisateur
     * @param module le module à vérifier
     * @return true si accès WRITE, false sinon
     */
    public boolean hasWriteAccess(String userId, PermissionModule module) {
<span class="fc" id="L77">        PermissionLevel level = getPermissionLevel(userId, module);</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">        return level == PermissionLevel.WRITE;</span>
    }

    /**
     * Récupère le niveau de permission pour un module spécifique.
     *
     * @param userId l'ID de l'utilisateur
     * @param module le module
     * @return le niveau de permission (NONE par défaut si introuvable)
     */
    public PermissionLevel getPermissionLevel(String userId, PermissionModule module) {
<span class="fc" id="L89">        return permissionRepository.findByUserIdAndModule(userId, module)</span>
<span class="fc" id="L90">                .map(UserPermission::getPermissionLevel)</span>
<span class="fc" id="L91">                .orElse(PermissionLevel.NONE);</span>
    }

    /**
     * Crée les permissions par défaut pour un nouvel utilisateur.
     * Cette méthode est idempotente : elle vérifie si la permission existe avant de
     * la créer.
     *
     * Permissions par défaut (WRITE pour tous les modules):
     * - CALENDAR: WRITE
     * - RELEASES: WRITE
     * - ADMIN: WRITE
     *
     * @param user l'utilisateur pour lequel créer les permissions
     */
    @Transactional
    public void createDefaultPermissions(User user) {
<span class="fc" id="L108">        createOrUpdatePermission(user, PermissionModule.CALENDAR, PermissionLevel.WRITE);</span>
<span class="fc" id="L109">        createOrUpdatePermission(user, PermissionModule.RELEASES, PermissionLevel.WRITE);</span>
<span class="fc" id="L110">        createOrUpdatePermission(user, PermissionModule.ADMIN, PermissionLevel.WRITE);</span>

<span class="fc" id="L112">        log.info(&quot;Permissions par défaut vérifiées/créées pour l'utilisateur {}&quot;, user.getEmail());</span>
<span class="fc" id="L113">    }</span>

    /**
     * Helper pour créer ou mettre à jour une permission spécifique
     */
    private void createOrUpdatePermission(User user, PermissionModule module, PermissionLevel level) {
<span class="fc" id="L119">        permissionRepository.findByUserIdAndModule(user.getId(), module)</span>
<span class="fc" id="L120">                .ifPresentOrElse(</span>
                        perm -&gt; {
<span class="nc bnc" id="L122" title="All 2 branches missed.">                            if (perm.getPermissionLevel() != level) {</span>
<span class="nc" id="L123">                                perm.setPermissionLevel(level);</span>
<span class="nc" id="L124">                                permissionRepository.save(perm);</span>
<span class="nc" id="L125">                                log.debug(&quot;Permission {} mise à jour pour {}&quot;, module, user.getEmail());</span>
                            }
<span class="nc" id="L127">                        },</span>
                        () -&gt; {
<span class="fc" id="L129">                            UserPermission newPerm = new UserPermission();</span>
<span class="fc" id="L130">                            newPerm.setUser(user);</span>
<span class="fc" id="L131">                            newPerm.setModule(module);</span>
<span class="fc" id="L132">                            newPerm.setPermissionLevel(level);</span>
<span class="fc" id="L133">                            permissionRepository.save(newPerm);</span>
<span class="fc" id="L134">                            log.debug(&quot;Permission {} créée pour {}&quot;, module, user.getEmail());</span>
<span class="fc" id="L135">                        });</span>
<span class="fc" id="L136">    }</span>

    /**
     * Met à jour les permissions d'un utilisateur.
     *
     * @param userId         l'ID de l'utilisateur
     * @param newPermissions Map des nouvelles permissions
     */
    @Transactional
    public void updateUserPermissions(String userId, Map&lt;PermissionModule, PermissionLevel&gt; newPermissions) {
<span class="fc" id="L146">        User user = userRepository.findById(userId)</span>
<span class="fc" id="L147">                .orElseThrow(() -&gt; new RuntimeException(&quot;Utilisateur non trouvé: &quot; + userId));</span>

<span class="fc bfc" id="L149" title="All 2 branches covered.">        for (Map.Entry&lt;PermissionModule, PermissionLevel&gt; entry : newPermissions.entrySet()) {</span>
<span class="fc" id="L150">            PermissionModule module = entry.getKey();</span>
<span class="fc" id="L151">            PermissionLevel newLevel = entry.getValue();</span>

<span class="fc" id="L153">            UserPermission permission = permissionRepository.findByUserIdAndModule(userId, module)</span>
<span class="fc" id="L154">                    .orElse(null);</span>

<span class="fc bfc" id="L156" title="All 2 branches covered.">            if (permission != null) {</span>
                // Mise à jour de la permission existante
<span class="fc" id="L158">                permission.setPermissionLevel(newLevel);</span>
<span class="fc" id="L159">                permissionRepository.save(permission);</span>
            } else {
                // Création d'une nouvelle permission
<span class="fc" id="L162">                UserPermission newPermission = new UserPermission();</span>
<span class="fc" id="L163">                newPermission.setUser(user);</span>
<span class="fc" id="L164">                newPermission.setModule(module);</span>
<span class="fc" id="L165">                newPermission.setPermissionLevel(newLevel);</span>
<span class="fc" id="L166">                permissionRepository.save(newPermission);</span>
            }
<span class="fc" id="L168">        }</span>

<span class="fc" id="L170">        log.info(&quot;Permissions mises à jour pour l'utilisateur {}: {}&quot;, userId, newPermissions);</span>
<span class="fc" id="L171">    }</span>

    /**
     * Retourne les permissions par défaut (utilisées en cas d'erreur).
     *
     * @return Map des permissions par défaut
     */
    private Map&lt;PermissionModule, PermissionLevel&gt; getDefaultPermissions() {
<span class="fc" id="L179">        Map&lt;PermissionModule, PermissionLevel&gt; defaults = new HashMap&lt;&gt;();</span>
<span class="fc" id="L180">        defaults.put(PermissionModule.CALENDAR, PermissionLevel.WRITE);</span>
<span class="fc" id="L181">        defaults.put(PermissionModule.RELEASES, PermissionLevel.WRITE);</span>
<span class="fc" id="L182">        defaults.put(PermissionModule.ADMIN, PermissionLevel.NONE);</span>
<span class="fc" id="L183">        return defaults;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>