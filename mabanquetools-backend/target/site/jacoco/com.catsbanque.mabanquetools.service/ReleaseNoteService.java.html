<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReleaseNoteService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Ma Banque Tools API</a> &gt; <a href="index.source.html" class="el_package">com.catsbanque.mabanquetools.service</a> &gt; <span class="el_source">ReleaseNoteService.java</span></div><h1>ReleaseNoteService.java</h1><pre class="source lang-java linenums">package com.catsbanque.mabanquetools.service;

import com.catsbanque.mabanquetools.dto.CreateReleaseNoteEntryRequest;
import com.catsbanque.mabanquetools.dto.ReleaseNoteEntryDto;
import com.catsbanque.mabanquetools.entity.Microservice;
import com.catsbanque.mabanquetools.entity.Release;
import com.catsbanque.mabanquetools.entity.ReleaseNoteEntry;
import com.catsbanque.mabanquetools.repository.MicroserviceRepository;
import com.catsbanque.mabanquetools.repository.ReleaseNoteEntryRepository;
import com.catsbanque.mabanquetools.repository.ReleaseRepository;
import tools.jackson.core.JacksonException;
import tools.jackson.core.type.TypeReference;
import tools.jackson.databind.ObjectMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.TreeMap;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
<span class="fc" id="L28">@Slf4j</span>
public class ReleaseNoteService {

        private final ReleaseNoteEntryRepository releaseNoteEntryRepository;
        private final ReleaseRepository releaseRepository;
        private final MicroserviceRepository microserviceRepository;
        private final com.catsbanque.mabanquetools.repository.FeatureRepository featureRepository;
        private final ObjectMapper objectMapper;

        /**
         * R√©cup√®re toutes les entr√©es d'une release
         */
        public List&lt;ReleaseNoteEntryDto&gt; getAllEntries(String releaseIdentifier) {
                // R√©soudre le slug vers l'ID r√©el (support pour slug OU ID)
<span class="fc" id="L42">                Release release = releaseRepository.findBySlug(releaseIdentifier)</span>
<span class="fc" id="L43">                                .or(() -&gt; releaseRepository.findById(releaseIdentifier))</span>
<span class="fc" id="L44">                                .orElseThrow(() -&gt; new RuntimeException(&quot;Release non trouv√©e: &quot; + releaseIdentifier));</span>

<span class="fc" id="L46">                List&lt;ReleaseNoteEntry&gt; entries = releaseNoteEntryRepository</span>
<span class="fc" id="L47">                                .findByReleaseIdOrderBySquadAndDeployOrder(release.getId());</span>
<span class="fc" id="L48">                return entries.stream()</span>
<span class="fc" id="L49">                                .map(this::convertToDto)</span>
<span class="fc" id="L50">                                .collect(Collectors.toList());</span>
        }

        /**
         * Cr√©e une nouvelle entr√©e
         */
        @Transactional
        public ReleaseNoteEntryDto createEntry(String releaseIdentifier, CreateReleaseNoteEntryRequest request) {
                // V√©rifier que la release existe (support slug OU ID)
<span class="fc" id="L59">                Release release = releaseRepository.findBySlug(releaseIdentifier)</span>
<span class="fc" id="L60">                                .or(() -&gt; releaseRepository.findById(releaseIdentifier))</span>
<span class="pc" id="L61">                                .orElseThrow(() -&gt; new RuntimeException(&quot;Release non trouv√©e: &quot; + releaseIdentifier));</span>

<span class="fc" id="L63">                ReleaseNoteEntry entry = new ReleaseNoteEntry();</span>
<span class="fc" id="L64">                entry.setReleaseId(release.getId());</span>

                // Handle microservice reference (preferred) or legacy free text
<span class="fc bfc" id="L67" title="All 2 branches covered.">                if (request.getMicroserviceId() != null) {</span>
                        // Use microservice reference
<span class="fc" id="L69">                        entry.setMicroserviceId(request.getMicroserviceId());</span>

                        // Optionally load microservice to get display name
<span class="fc" id="L72">                        microserviceRepository.findById(request.getMicroserviceId())</span>
<span class="fc" id="L73">                                        .ifPresent(ms -&gt; entry.setMicroservice(ms.getName()));</span>
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">                } else if (request.getMicroservice() != null) {</span>
                        // Legacy: free text microservice name
<span class="fc" id="L76">                        entry.setMicroservice(request.getMicroservice());</span>
                }

<span class="fc" id="L79">                entry.setSquad(request.getSquad());</span>
<span class="fc" id="L80">                entry.setPartEnMep(request.getPartEnMep());</span>
<span class="fc" id="L81">                entry.setDeployOrder(request.getDeployOrder());</span>
<span class="fc" id="L82">                entry.setTag(request.getTag());</span>
<span class="fc" id="L83">                entry.setPreviousTag(request.getPreviousTag());</span>
<span class="fc" id="L84">                entry.setParentVersion(request.getParentVersion());</span>
<span class="fc" id="L85">                entry.setComment(request.getComment());</span>
<span class="fc" id="L86">                entry.setStatus(request.getStatus());</span>

                // Convertir les changes en JSON
                try {
<span class="fc" id="L90">                        String changesJson = objectMapper.writeValueAsString(request.getChanges());</span>
<span class="fc" id="L91">                        entry.setChanges(changesJson);</span>
<span class="fc" id="L92">                } catch (JacksonException e) {</span>
<span class="fc" id="L93">                        log.error(&quot;Erreur lors de la conversion des changes en JSON&quot;, e);</span>
<span class="fc" id="L94">                        entry.setChanges(&quot;[]&quot;);</span>
<span class="fc" id="L95">                }</span>

<span class="fc" id="L97">                ReleaseNoteEntry saved = releaseNoteEntryRepository.save(entry);</span>
<span class="fc" id="L98">                return convertToDto(saved);</span>
        }

        /**
         * Met √† jour une entr√©e existante
         */
        @Transactional
        public ReleaseNoteEntryDto updateEntry(String releaseIdentifier, String entryId,
                        CreateReleaseNoteEntryRequest request) {
                // R√©soudre le slug vers l'ID r√©el (support slug OU ID)
<span class="fc" id="L108">                Release release = releaseRepository.findBySlug(releaseIdentifier)</span>
<span class="fc" id="L109">                                .or(() -&gt; releaseRepository.findById(releaseIdentifier))</span>
<span class="pc" id="L110">                                .orElseThrow(() -&gt; new RuntimeException(&quot;Release non trouv√©e: &quot; + releaseIdentifier));</span>

<span class="fc" id="L112">                ReleaseNoteEntry entry = releaseNoteEntryRepository.findById(entryId)</span>
<span class="fc" id="L113">                                .orElseThrow(() -&gt; new RuntimeException(&quot;Entr√©e non trouv√©e avec l'id: &quot; + entryId));</span>

                // V√©rifier que l'entr√©e appartient bien √† la release
<span class="fc bfc" id="L116" title="All 2 branches covered.">                if (!entry.getReleaseId().equals(release.getId())) {</span>
<span class="fc" id="L117">                        throw new RuntimeException(&quot;L'entr√©e n'appartient pas √† cette release&quot;);</span>
                }

                // Handle microservice reference (preferred) or legacy free text
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">                if (request.getMicroserviceId() != null) {</span>
                        // Use microservice reference
<span class="fc" id="L123">                        entry.setMicroserviceId(request.getMicroserviceId());</span>

                        // Optionally load microservice to get display name
<span class="fc" id="L126">                        microserviceRepository.findById(request.getMicroserviceId())</span>
<span class="fc" id="L127">                                        .ifPresent(ms -&gt; entry.setMicroservice(ms.getName()));</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">                } else if (request.getMicroservice() != null) {</span>
                        // Legacy: free text microservice name
<span class="nc" id="L130">                        entry.setMicroservice(request.getMicroservice());</span>
                }

<span class="fc" id="L133">                entry.setSquad(request.getSquad());</span>
<span class="fc" id="L134">                entry.setPartEnMep(request.getPartEnMep());</span>
<span class="fc" id="L135">                entry.setDeployOrder(request.getDeployOrder());</span>
<span class="fc" id="L136">                entry.setTag(request.getTag());</span>
<span class="fc" id="L137">                entry.setPreviousTag(request.getPreviousTag());</span>
<span class="fc" id="L138">                entry.setParentVersion(request.getParentVersion());</span>
<span class="fc" id="L139">                entry.setComment(request.getComment());</span>
<span class="fc" id="L140">                entry.setStatus(request.getStatus());</span>

                // Convertir les changes en JSON
                try {
<span class="fc" id="L144">                        String changesJson = objectMapper.writeValueAsString(request.getChanges());</span>
<span class="fc" id="L145">                        entry.setChanges(changesJson);</span>
<span class="nc" id="L146">                } catch (JacksonException e) {</span>
<span class="nc" id="L147">                        log.error(&quot;Erreur lors de la conversion des changes en JSON&quot;, e);</span>
<span class="nc" id="L148">                        entry.setChanges(&quot;[]&quot;);</span>
<span class="fc" id="L149">                }</span>

<span class="fc" id="L151">                ReleaseNoteEntry updated = releaseNoteEntryRepository.save(entry);</span>
<span class="fc" id="L152">                return convertToDto(updated);</span>
        }

        /**
         * Supprime une entr√©e
         */
        @Transactional
        public void deleteEntry(String releaseIdentifier, String entryId) {
                // R√©soudre le slug vers l'ID r√©el (support slug OU ID)
<span class="fc" id="L161">                Release release = releaseRepository.findBySlug(releaseIdentifier)</span>
<span class="fc" id="L162">                                .or(() -&gt; releaseRepository.findById(releaseIdentifier))</span>
<span class="pc" id="L163">                                .orElseThrow(() -&gt; new RuntimeException(&quot;Release non trouv√©e: &quot; + releaseIdentifier));</span>

<span class="fc" id="L165">                ReleaseNoteEntry entry = releaseNoteEntryRepository.findById(entryId)</span>
<span class="pc" id="L166">                                .orElseThrow(() -&gt; new RuntimeException(&quot;Entr√©e non trouv√©e avec l'id: &quot; + entryId));</span>

                // V√©rifier que l'entr√©e appartient bien √† la release
<span class="fc bfc" id="L169" title="All 2 branches covered.">                if (!entry.getReleaseId().equals(release.getId())) {</span>
<span class="fc" id="L170">                        throw new RuntimeException(&quot;L'entr√©e n'appartient pas √† cette release&quot;);</span>
                }

<span class="fc" id="L173">                releaseNoteEntryRepository.delete(entry);</span>
<span class="fc" id="L174">        }</span>

        /**
         * R√©cup√®re tous les tags pr√©c√©dents (N-1) pour tous les microservices d'une
         * release
         * Retourne une Map&lt;microserviceId, previousTag&gt;
         *
         * Utilis√© par MicroserviceService pour enrichir les microservices avec
         * previousTag
         */
        public Map&lt;String, String&gt; getAllPreviousTags(String currentReleaseId) {
<span class="fc" id="L185">                List&lt;ReleaseNoteEntry&gt; previousEntries = releaseNoteEntryRepository</span>
<span class="fc" id="L186">                                .findAllPreviousTagsForRelease(currentReleaseId);</span>

<span class="fc" id="L188">                Map&lt;String, String&gt; previousTags = new java.util.HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L189" title="All 2 branches covered.">                for (ReleaseNoteEntry entry : previousEntries) {</span>
<span class="pc bpc" id="L190" title="1 of 4 branches missed.">                        if (entry.getMicroserviceId() != null &amp;&amp; entry.getTag() != null) {</span>
<span class="fc" id="L191">                                previousTags.put(entry.getMicroserviceId(), entry.getTag());</span>
                        }
<span class="fc" id="L193">                }</span>

<span class="fc" id="L195">                return previousTags;</span>
        }

        /**
         * Exporte la release note en Markdown (colonnes filtr√©es: microservice,
         * solution, squad, changes)
         */
        public String exportMarkdown(String releaseIdentifier) {
                // R√©soudre le slug vers l'ID r√©el (support slug OU ID)
<span class="fc" id="L204">                Release release = releaseRepository.findBySlug(releaseIdentifier)</span>
<span class="fc" id="L205">                                .or(() -&gt; releaseRepository.findById(releaseIdentifier))</span>
<span class="pc" id="L206">                                .orElseThrow(() -&gt; new RuntimeException(&quot;Release non trouv√©e: &quot; + releaseIdentifier));</span>

<span class="fc" id="L208">                List&lt;ReleaseNoteEntry&gt; entries = releaseNoteEntryRepository</span>
<span class="fc" id="L209">                                .findByReleaseIdOrderBySquadAndDeployOrder(release.getId());</span>

                // Filtrer uniquement les entr√©es d√©ploy√©es (partEnMep=true)
<span class="fc" id="L212">                List&lt;ReleaseNoteEntry&gt; deployed = entries.stream()</span>
<span class="pc bpc" id="L213" title="1 of 4 branches missed.">                                .filter(e -&gt; e.getPartEnMep() != null &amp;&amp; e.getPartEnMep())</span>
<span class="fc" id="L214">                                .collect(Collectors.toList());</span>

                // Grouper par squad
<span class="fc" id="L217">                Map&lt;String, List&lt;ReleaseNoteEntry&gt;&gt; entriesBySquad = deployed.stream()</span>
<span class="fc" id="L218">                                .collect(Collectors.groupingBy(</span>
                                                ReleaseNoteEntry::getSquad,
                                                TreeMap::new,
<span class="fc" id="L221">                                                Collectors.toList()));</span>

<span class="fc" id="L223">                StringBuilder markdown = new StringBuilder();</span>
<span class="fc" id="L224">                DateTimeFormatter dateFormatter = DateTimeFormatter.ofPattern(&quot;dd MMMM yyyy&quot;);</span>

                // Header
<span class="fc" id="L227">                markdown.append(&quot;# Release Note - &quot;).append(release.getName()).append(&quot;\n\n&quot;);</span>
<span class="fc" id="L228">                markdown.append(&quot;**Date de MEP**: &quot;).append(release.getReleaseDate().format(dateFormatter))</span>
<span class="fc" id="L229">                                .append(&quot;\n\n&quot;);</span>
<span class="pc bpc" id="L230" title="3 of 4 branches missed.">                if (release.getDescription() != null &amp;&amp; !release.getDescription().isEmpty()) {</span>
<span class="nc" id="L231">                        markdown.append(release.getDescription()).append(&quot;\n\n&quot;);</span>
                }
<span class="fc" id="L233">                markdown.append(&quot;---\n\n&quot;);</span>

                // Contenu par squad (uniquement colonnes: microservice, solution, squad,
                // changes)
<span class="fc bfc" id="L237" title="All 2 branches covered.">                for (Map.Entry&lt;String, List&lt;ReleaseNoteEntry&gt;&gt; squadEntry : entriesBySquad.entrySet()) {</span>
<span class="fc" id="L238">                        String squad = squadEntry.getKey();</span>
<span class="fc" id="L239">                        List&lt;ReleaseNoteEntry&gt; squadEntries = squadEntry.getValue();</span>

<span class="fc" id="L241">                        markdown.append(&quot;## &quot;).append(squad).append(&quot;\n\n&quot;);</span>

<span class="fc" id="L243">                        markdown.append(&quot;| Microservice | Solution | Changes |\n&quot;);</span>
<span class="fc" id="L244">                        markdown.append(&quot;|-------------|----------|----------|\n&quot;);</span>

<span class="fc bfc" id="L246" title="All 2 branches covered.">                        for (ReleaseNoteEntry entry : squadEntries) {</span>
                                // R√©cup√©rer solution depuis le microservice
<span class="fc" id="L248">                                String solution = &quot;-&quot;;</span>
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">                                if (entry.getMicroserviceId() != null) {</span>
<span class="fc" id="L250">                                        solution = microserviceRepository.findById(entry.getMicroserviceId())</span>
<span class="fc" id="L251">                                                        .map(Microservice::getSolution)</span>
<span class="fc" id="L252">                                                        .orElse(&quot;-&quot;);</span>
                                }

<span class="fc" id="L255">                                markdown.append(&quot;| &quot;)</span>
<span class="pc bpc" id="L256" title="1 of 2 branches missed.">                                                .append(entry.getMicroservice() != null ? entry.getMicroservice() : &quot;-&quot;)</span>
<span class="fc" id="L257">                                                .append(&quot; | &quot;)</span>
<span class="fc" id="L258">                                                .append(solution)</span>
<span class="fc" id="L259">                                                .append(&quot; | &quot;);</span>

                                // Changes
<span class="fc" id="L262">                                List&lt;ReleaseNoteEntryDto.ChangeItem&gt; changes = parseChanges(entry.getChanges());</span>
<span class="pc bpc" id="L263" title="1 of 2 branches missed.">                                if (changes.isEmpty()) {</span>
<span class="fc" id="L264">                                        markdown.append(&quot;-&quot;);</span>
                                } else {
<span class="nc" id="L266">                                        markdown.append(changes.stream()</span>
<span class="nc" id="L267">                                                        .map(c -&gt; &quot;**&quot; + c.getJiraId() + &quot;**: &quot; + c.getDescription())</span>
<span class="nc" id="L268">                                                        .collect(Collectors.joining(&quot;&lt;br&gt;&quot;)));</span>
                                }
<span class="fc" id="L270">                                markdown.append(&quot; |\n&quot;);</span>
<span class="fc" id="L271">                        }</span>
<span class="fc" id="L272">                        markdown.append(&quot;\n---\n\n&quot;);</span>
<span class="fc" id="L273">                }</span>

<span class="fc" id="L275">                return markdown.toString();</span>
        }

        /**
         * Exporte la release note en HTML avec design &quot;wow&quot; (colonnes filtr√©es:
         * microservice, solution, squad, changes)
         */
        public String exportHtml(String releaseIdentifier) {
                // R√©soudre le slug vers l'ID r√©el (support slug OU ID)
<span class="fc" id="L284">                Release release = releaseRepository.findBySlug(releaseIdentifier)</span>
<span class="fc" id="L285">                                .or(() -&gt; releaseRepository.findById(releaseIdentifier))</span>
<span class="pc" id="L286">                                .orElseThrow(() -&gt; new RuntimeException(&quot;Release non trouv√©e: &quot; + releaseIdentifier));</span>

<span class="fc" id="L288">                List&lt;ReleaseNoteEntry&gt; entries = releaseNoteEntryRepository</span>
<span class="fc" id="L289">                                .findByReleaseIdOrderBySquadAndDeployOrder(release.getId());</span>

                // Filtrer uniquement les entr√©es d√©ploy√©es (partEnMep=true)
<span class="fc" id="L292">                List&lt;ReleaseNoteEntry&gt; deployed = entries.stream()</span>
<span class="pc bpc" id="L293" title="1 of 4 branches missed.">                                .filter(e -&gt; e.getPartEnMep() != null &amp;&amp; e.getPartEnMep())</span>
<span class="fc" id="L294">                                .collect(Collectors.toList());</span>

                // Grouper par squad
<span class="fc" id="L297">                Map&lt;String, List&lt;ReleaseNoteEntry&gt;&gt; entriesBySquad = deployed.stream()</span>
<span class="fc" id="L298">                                .collect(Collectors.groupingBy(</span>
                                                ReleaseNoteEntry::getSquad,
                                                TreeMap::new,
<span class="fc" id="L301">                                                Collectors.toList()));</span>

<span class="fc" id="L303">                StringBuilder html = new StringBuilder();</span>
<span class="fc" id="L304">                DateTimeFormatter dateFormatter = DateTimeFormatter.ofPattern(&quot;dd MMMM yyyy&quot;);</span>

                // Couleurs par squad
<span class="fc" id="L307">                String[] squadColors = {</span>
                                &quot;#10b981&quot;, // Squad 1 - Emerald
                                &quot;#3b82f6&quot;, // Squad 2 - Blue
                                &quot;#8b5cf6&quot;, // Squad 3 - Purple
                                &quot;#f59e0b&quot;, // Squad 4 - Amber
                                &quot;#ef4444&quot;, // Squad 5 - Red
                                &quot;#06b6d4&quot; // Squad 6 - Cyan
                };

                // Fetch Major Features
<span class="fc" id="L317">                List&lt;com.catsbanque.mabanquetools.entity.Feature&gt; majorFeatures = featureRepository</span>
<span class="fc" id="L318">                                .findByReleaseIdAndType(release.getId(), &quot;major&quot;);</span>

                // Header HTML avec design moderne
<span class="fc" id="L321">                html.append(&quot;&lt;!DOCTYPE html&gt;\n&quot;);</span>
<span class="fc" id="L322">                html.append(&quot;&lt;html lang=\&quot;fr\&quot;&gt;\n&quot;);</span>
<span class="fc" id="L323">                html.append(&quot;&lt;head&gt;\n&quot;);</span>
<span class="fc" id="L324">                html.append(&quot;  &lt;meta charset=\&quot;UTF-8\&quot;&gt;\n&quot;);</span>
<span class="fc" id="L325">                html.append(&quot;  &lt;meta name=\&quot;viewport\&quot; content=\&quot;width=device-width, initial-scale=1.0\&quot;&gt;\n&quot;);</span>
<span class="fc" id="L326">                html.append(&quot;  &lt;title&gt;Release Note - &quot;).append(release.getName()).append(&quot;&lt;/title&gt;\n&quot;);</span>
<span class="fc" id="L327">                html.append(</span>
                                &quot;  &lt;link href=\&quot;https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&amp;family=Inter:wght@400;500;600&amp;display=swap\&quot; rel=\&quot;stylesheet\&quot;&gt;\n&quot;);
<span class="fc" id="L329">                html.append(&quot;  &lt;style&gt;\n&quot;);</span>
<span class="fc" id="L330">                html.append(&quot;    * { margin: 0; padding: 0; box-sizing: border-box; }\n&quot;);</span>
<span class="fc" id="L331">                html.append(</span>
                                &quot;    body { font-family: 'Inter', sans-serif; background-color: #f8fafc; color: #1e293b; line-height: 1.4; padding: 1.5rem; }\n&quot;);
<span class="fc" id="L333">                html.append(&quot;    .container { max-width: 1200px; margin: 0 auto; }\n&quot;);</span>

                // Header Styles
<span class="fc" id="L336">                html.append(</span>
                                &quot;    .header { background: linear-gradient(135deg, #10b981 0%, #047857 100%); color: white; border-radius: 16px; padding: 2rem; margin-bottom: 2rem; position: relative; overflow: hidden; box-shadow: 0 10px 25px -5px rgba(16, 185, 129, 0.4); }\n&quot;);
<span class="fc" id="L338">                html.append(</span>
                                &quot;    .header::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at top right, rgba(255,255,255,0.2), transparent 70%); pointer-events: none; }\n&quot;);
<span class="fc" id="L340">                html.append(</span>
                                &quot;    .header h1 { font-family: 'Outfit', sans-serif; font-size: 2.25rem; font-weight: 800; margin-bottom: 0.5rem; letter-spacing: -0.02em; position: relative; }\n&quot;);
<span class="fc" id="L342">                html.append(</span>
                                &quot;    .header-meta { display: flex; align-items: center; gap: 1.5rem; position: relative; font-family: 'Outfit', sans-serif; font-size: 0.95rem; }\n&quot;);
<span class="fc" id="L344">                html.append(</span>
                                &quot;    .date-badge { background: rgba(255,255,255,0.25); backdrop-filter: blur(8px); padding: 0.35rem 0.85rem; border-radius: 8px; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; border: 1px solid rgba(255,255,255,0.2); }\n&quot;);

                // Major Features Styles
<span class="fc" id="L348">                html.append(</span>
                                &quot;    .section-title { font-family: 'Outfit', sans-serif; font-size: 1.4rem; font-weight: 700; color: #0f172a; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.6rem; }\n&quot;);
<span class="fc" id="L350">                html.append(</span>
                                &quot;    .section-title span { background: #10b981; color: white; width: 2rem; height: 2rem; display: flex; align-items: center; justify-content: center; border-radius: 8px; font-size: 1.1rem; box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.3); }\n&quot;);
<span class="fc" id="L352">                html.append(</span>
                                &quot;    .major-features-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; margin-bottom: 2.5rem; }\n&quot;);
<span class="fc" id="L354">                html.append(</span>
                                &quot;    .feature-card { background: white; border-radius: 12px; padding: 1.25rem; transition: transform 0.2s; border: 1px solid #e2e8f0; position: relative; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }\n&quot;);
<span class="fc" id="L356">                html.append(</span>
                                &quot;    .feature-card::before { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: linear-gradient(to bottom, #10b981, #34d399); }\n&quot;);
<span class="fc" id="L358">                html.append(</span>
                                &quot;    .feature-card h3 { font-family: 'Outfit', sans-serif; font-size: 1.1rem; font-weight: 700; color: #1e293b; margin-bottom: 0.5rem; }\n&quot;);
<span class="fc" id="L360">                html.append(&quot;    .feature-card p { color: #64748b; font-size: 0.95rem; line-height: 1.5; }\n&quot;);</span>

                // Detailed Changes Styles
<span class="fc" id="L363">                html.append(</span>
                                &quot;    .details-section { opacity: 0.95; margin-top: 2.5rem; padding-top: 2.5rem; border-top: 1px dashed #cbd5e1; }\n&quot;);
<span class="fc" id="L365">                html.append(</span>
                                &quot;    .squads-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; align-items: start; }\n&quot;);
<span class="fc" id="L367">                html.append(&quot;    @media (max-width: 1000px) { .squads-grid { grid-template-columns: 1fr; } }\n&quot;);</span>
<span class="fc" id="L368">                html.append(</span>
                                &quot;    .squad-group { margin-bottom: 0; background: white; border-radius: 12px; box-shadow: 0 2px 4px -1px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #f1f5f9; }\n&quot;);
<span class="fc" id="L370">                html.append(</span>
                                &quot;    .squad-header { padding: 0.75rem 1.5rem; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #f1f5f9; background: #f8fafc; }\n&quot;);
<span class="fc" id="L372">                html.append(</span>
                                &quot;    .squad-title { font-family: 'Outfit', sans-serif; font-size: 1.05rem; font-weight: 700; color: #334155; display: flex; align-items: center; gap: 0.6rem; }\n&quot;);
<span class="fc" id="L374">                html.append(</span>
                                &quot;    .squad-dot { width: 10px; height: 10px; border-radius: 50%; background: var(--squad-color); display: inline-block; box-shadow: 0 0 0 3px rgba(255,255,255,0.5); }\n&quot;);
<span class="fc" id="L376">                html.append(</span>
                                &quot;    .microservice-row { display: grid; grid-template-columns: 180px 1fr; gap: 1.5rem; padding: 1rem 1.5rem; border-bottom: 1px solid #f1f5f9; align-items: start; transition: background 0.2s; }\n&quot;);
<span class="fc" id="L378">                html.append(&quot;    .microservice-row:last-child { border-bottom: none; }\n&quot;);</span>
<span class="fc" id="L379">                html.append(&quot;    .microservice-row:hover { background: #f8fafc; }\n&quot;);</span>
<span class="fc" id="L380">                html.append(&quot;    .ms-info { font-weight: 600; color: #475569; font-size: 0.9rem; }\n&quot;);</span>
<span class="fc" id="L381">                html.append(</span>
                                &quot;    .ms-solution { font-size: 0.75rem; color: #94a3b8; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; margin-top: 0.15rem; }\n&quot;);
<span class="fc" id="L383">                html.append(&quot;    .changes-list { display: flex; flex-direction: column; gap: 0.5rem; }\n&quot;);</span>
<span class="fc" id="L384">                html.append(</span>
                                &quot;    .change-item { display: flex; gap: 0.75rem; align-items: baseline; font-size: 0.9rem; color: #334155; }\n&quot;);
<span class="fc" id="L386">                html.append(</span>
                                &quot;    .jira-tag { background: #f1f5f9; color: #64748b; font-size: 0.7rem; font-weight: 700; padding: 0.15rem 0.5rem; border-radius: 4px; white-space: nowrap; font-family: 'Inter', monospace; border: 1px solid #e2e8f0; }\n&quot;);
<span class="fc" id="L388">                html.append(&quot;    .no-changes { color: #94a3b8; font-style: italic; font-size: 0.85rem; }\n&quot;);</span>

<span class="fc" id="L390">                html.append(&quot;  &lt;/style&gt;\n&quot;);</span>
<span class="fc" id="L391">                html.append(&quot;&lt;/head&gt;\n&quot;);</span>
<span class="fc" id="L392">                html.append(&quot;&lt;body&gt;\n&quot;);</span>
<span class="fc" id="L393">                html.append(&quot;  &lt;div class=\&quot;container\&quot;&gt;\n&quot;);</span>

                // Header
<span class="fc" id="L396">                html.append(&quot;    &lt;div class=\&quot;header\&quot;&gt;\n&quot;);</span>
<span class="fc" id="L397">                html.append(&quot;      &lt;h1&gt;&quot;).append(release.getName()).append(&quot;&lt;/h1&gt;\n&quot;);</span>
<span class="fc" id="L398">                html.append(&quot;      &lt;div class=\&quot;header-meta\&quot;&gt;\n&quot;);</span>
<span class="fc" id="L399">                html.append(&quot;        &lt;div class=\&quot;date-badge\&quot;&gt;üìÖ &quot;)</span>
<span class="fc" id="L400">                                .append(release.getReleaseDate().format(dateFormatter))</span>
<span class="fc" id="L401">                                .append(&quot;&lt;/div&gt;\n&quot;);</span>
<span class="pc bpc" id="L402" title="3 of 4 branches missed.">                if (release.getDescription() != null &amp;&amp; !release.getDescription().isEmpty()) {</span>
<span class="nc" id="L403">                        html.append(&quot;        &lt;div&gt;&quot;).append(release.getDescription()).append(&quot;&lt;/div&gt;\n&quot;);</span>
                }
<span class="fc" id="L405">                html.append(&quot;      &lt;/div&gt;\n&quot;);</span>
<span class="fc" id="L406">                html.append(&quot;    &lt;/div&gt;\n&quot;);</span>

                // MAJOR FEATURES SECTION
<span class="pc bpc" id="L409" title="1 of 2 branches missed.">                if (!majorFeatures.isEmpty()) {</span>
<span class="nc" id="L410">                        html.append(&quot;    &lt;div class=\&quot;section-title\&quot;&gt;&lt;span&gt;‚òÖ&lt;/span&gt; Fonctionnalit√©s Majeures&lt;/div&gt;\n&quot;);</span>
<span class="nc" id="L411">                        html.append(&quot;    &lt;div class=\&quot;major-features-grid\&quot;&gt;\n&quot;);</span>
<span class="nc bnc" id="L412" title="All 2 branches missed.">                        for (com.catsbanque.mabanquetools.entity.Feature feature : majorFeatures) {</span>
<span class="nc" id="L413">                                html.append(&quot;      &lt;div class=\&quot;feature-card\&quot;&gt;\n&quot;);</span>
<span class="nc" id="L414">                                html.append(&quot;        &lt;h3&gt;&quot;).append(feature.getTitle()).append(&quot;&lt;/h3&gt;\n&quot;);</span>
<span class="nc bnc" id="L415" title="All 4 branches missed.">                                if (feature.getDescription() != null &amp;&amp; !feature.getDescription().isEmpty()) {</span>
<span class="nc" id="L416">                                        html.append(&quot;        &lt;p&gt;&quot;).append(feature.getDescription()).append(&quot;&lt;/p&gt;\n&quot;);</span>
                                }
<span class="nc" id="L418">                                html.append(&quot;      &lt;/div&gt;\n&quot;);</span>
<span class="nc" id="L419">                        }</span>
<span class="nc" id="L420">                        html.append(&quot;    &lt;/div&gt;\n&quot;);</span>
                }

                // DETAILED SQUADS SECTION
<span class="fc" id="L424">                html.append(&quot;    &lt;div class=\&quot;details-section\&quot;&gt;\n&quot;);</span>
<span class="fc" id="L425">                html.append(</span>
                                &quot;      &lt;div class=\&quot;section-title\&quot; style=\&quot;font-size: 1.5rem; color: #64748b;\&quot;&gt;&lt;span&gt;üìã&lt;/span&gt; D√©tails techniques par Squad&lt;/div&gt;\n\n&quot;);
<span class="fc" id="L427">                html.append(&quot;      &lt;div class=\&quot;squads-grid\&quot;&gt;\n&quot;);</span>

<span class="fc" id="L429">                int squadIndex = 0;</span>
<span class="fc bfc" id="L430" title="All 2 branches covered.">                for (Map.Entry&lt;String, List&lt;ReleaseNoteEntry&gt;&gt; squadEntry : entriesBySquad.entrySet()) {</span>
<span class="fc" id="L431">                        String squad = squadEntry.getKey();</span>
<span class="fc" id="L432">                        List&lt;ReleaseNoteEntry&gt; squadEntries = squadEntry.getValue();</span>
<span class="fc" id="L433">                        String squadColor = squadColors[squadIndex % squadColors.length];</span>

<span class="fc" id="L435">                        html.append(&quot;      &lt;div class=\&quot;squad-group\&quot; style=\&quot;--squad-color: &quot;).append(squadColor)</span>
<span class="fc" id="L436">                                        .append(&quot;;\&quot;&gt;\n&quot;);</span>
<span class="fc" id="L437">                        html.append(&quot;        &lt;div class=\&quot;squad-header\&quot;&gt;\n&quot;);</span>
<span class="fc" id="L438">                        html.append(&quot;          &lt;div class=\&quot;squad-title\&quot;&gt;&lt;span class=\&quot;squad-dot\&quot;&gt;&lt;/span&gt;&quot;)</span>
<span class="fc" id="L439">                                        .append(squad)</span>
<span class="fc" id="L440">                                        .append(&quot;&lt;/div&gt;\n&quot;);</span>
<span class="fc" id="L441">                        html.append(&quot;          &lt;div style=\&quot;color: #94a3b8; font-weight: 500; font-size: 0.9rem;\&quot;&gt;&quot;)</span>
<span class="fc" id="L442">                                        .append(squadEntries.size()).append(&quot; microservices&lt;/div&gt;\n&quot;);</span>
<span class="fc" id="L443">                        html.append(&quot;        &lt;/div&gt;\n&quot;);</span>

                        // Microservice rows
<span class="fc bfc" id="L446" title="All 2 branches covered.">                        for (ReleaseNoteEntry entry : squadEntries) {</span>
<span class="fc" id="L447">                                String solution = &quot;-&quot;;</span>
<span class="pc bpc" id="L448" title="1 of 2 branches missed.">                                if (entry.getMicroserviceId() != null) {</span>
<span class="fc" id="L449">                                        solution = microserviceRepository.findById(entry.getMicroserviceId())</span>
<span class="fc" id="L450">                                                        .map(Microservice::getSolution)</span>
<span class="fc" id="L451">                                                        .orElse(&quot;-&quot;);</span>
                                }

<span class="fc" id="L454">                                html.append(&quot;        &lt;div class=\&quot;microservice-row\&quot;&gt;\n&quot;);</span>

                                // Column 1: Microservice Info
<span class="fc" id="L457">                                html.append(&quot;          &lt;div&gt;\n&quot;);</span>
<span class="fc" id="L458">                                html.append(&quot;            &lt;div class=\&quot;ms-info\&quot;&gt;&quot;)</span>
<span class="pc bpc" id="L459" title="1 of 2 branches missed.">                                                .append(entry.getMicroservice() != null ? entry.getMicroservice() : &quot;-&quot;)</span>
<span class="fc" id="L460">                                                .append(&quot;&lt;/div&gt;\n&quot;);</span>
<span class="fc" id="L461">                                html.append(&quot;            &lt;div class=\&quot;ms-solution\&quot;&gt;&quot;).append(solution)</span>
<span class="fc" id="L462">                                                .append(&quot;&lt;/div&gt;\n&quot;);</span>
<span class="fc" id="L463">                                html.append(&quot;          &lt;/div&gt;\n&quot;);</span>

                                // Column 2: Changes
<span class="fc" id="L466">                                html.append(&quot;          &lt;div class=\&quot;changes-list\&quot;&gt;\n&quot;);</span>
<span class="fc" id="L467">                                List&lt;ReleaseNoteEntryDto.ChangeItem&gt; changes = parseChanges(entry.getChanges());</span>

<span class="pc bpc" id="L469" title="1 of 2 branches missed.">                                if (changes.isEmpty()) {</span>
<span class="fc" id="L470">                                        html.append(&quot;            &lt;div class=\&quot;no-changes\&quot;&gt;Aucun changement notable&lt;/div&gt;\n&quot;);</span>
                                } else {
<span class="nc bnc" id="L472" title="All 2 branches missed.">                                        for (ReleaseNoteEntryDto.ChangeItem change : changes) {</span>
<span class="nc" id="L473">                                                html.append(&quot;            &lt;div class=\&quot;change-item\&quot;&gt;\n&quot;);</span>
<span class="nc" id="L474">                                                html.append(&quot;              &lt;span class=\&quot;jira-tag\&quot;&gt;&quot;)</span>
<span class="nc" id="L475">                                                                .append(change.getJiraId())</span>
<span class="nc" id="L476">                                                                .append(&quot;&lt;/span&gt;\n&quot;);</span>
<span class="nc" id="L477">                                                html.append(&quot;              &lt;span&gt;&quot;).append(change.getDescription())</span>
<span class="nc" id="L478">                                                                .append(&quot;&lt;/span&gt;\n&quot;);</span>
<span class="nc" id="L479">                                                html.append(&quot;            &lt;/div&gt;\n&quot;);</span>
<span class="nc" id="L480">                                        }</span>
                                }
<span class="fc" id="L482">                                html.append(&quot;          &lt;/div&gt;\n&quot;);</span>

<span class="fc" id="L484">                                html.append(&quot;        &lt;/div&gt;\n&quot;); // End microservice-row</span>
<span class="fc" id="L485">                        }</span>

<span class="fc" id="L487">                        html.append(&quot;      &lt;/div&gt;\n&quot;); // End squad-group</span>
<span class="fc" id="L488">                        squadIndex++;</span>
<span class="fc" id="L489">                }</span>
<span class="fc" id="L490">                html.append(&quot;      &lt;/div&gt;\n&quot;); // End squads-grid</span>

<span class="fc" id="L492">                html.append(&quot;    &lt;/div&gt;\n&quot;); // End details-section</span>
<span class="fc" id="L493">                html.append(&quot;  &lt;/div&gt;\n&quot;); // End container</span>
<span class="fc" id="L494">                html.append(&quot;&lt;/body&gt;\n&quot;);</span>
<span class="fc" id="L495">                html.append(&quot;&lt;/html&gt;\n&quot;);</span>

<span class="fc" id="L497">                return html.toString();</span>
        }

        /**
         * Convertit une entit√© en DTO
         */
        private ReleaseNoteEntryDto convertToDto(ReleaseNoteEntry entry) {
<span class="fc" id="L504">                ReleaseNoteEntryDto dto = new ReleaseNoteEntryDto();</span>
<span class="fc" id="L505">                dto.setId(entry.getId());</span>
<span class="fc" id="L506">                dto.setReleaseId(entry.getReleaseId());</span>

                // Microservice information
<span class="fc" id="L509">                dto.setMicroserviceId(entry.getMicroserviceId());</span>
<span class="fc" id="L510">                dto.setMicroservice(entry.getMicroservice()); // Legacy field</span>

                // If microservice reference exists, load additional info
<span class="pc bpc" id="L513" title="1 of 2 branches missed.">                if (entry.getMicroserviceId() != null) {</span>
<span class="fc" id="L514">                        microserviceRepository.findById(entry.getMicroserviceId())</span>
<span class="fc" id="L515">                                        .ifPresent(ms -&gt; {</span>
<span class="fc" id="L516">                                                dto.setMicroserviceName(ms.getName());</span>
<span class="fc" id="L517">                                                dto.setSolution(ms.getSolution());</span>
                                                // If legacy field is empty, populate it from entity
<span class="pc bpc" id="L519" title="1 of 2 branches missed.">                                                if (dto.getMicroservice() == null) {</span>
<span class="nc" id="L520">                                                        dto.setMicroservice(ms.getName());</span>
                                                }
<span class="fc" id="L522">                                        });</span>
                } else {
                        // Legacy: use free text microservice name
<span class="nc" id="L525">                        dto.setMicroserviceName(entry.getMicroservice());</span>
                }

<span class="fc" id="L528">                dto.setSquad(entry.getSquad());</span>
<span class="fc" id="L529">                dto.setPartEnMep(entry.getPartEnMep());</span>
<span class="fc" id="L530">                dto.setDeployOrder(entry.getDeployOrder());</span>
<span class="fc" id="L531">                dto.setTag(entry.getTag());</span>
<span class="fc" id="L532">                dto.setPreviousTag(entry.getPreviousTag());</span>
<span class="fc" id="L533">                dto.setParentVersion(entry.getParentVersion());</span>
<span class="fc" id="L534">                dto.setComment(entry.getComment());</span>
<span class="fc" id="L535">                dto.setStatus(entry.getStatus());</span>
<span class="fc" id="L536">                dto.setCreatedAt(entry.getCreatedAt());</span>
<span class="fc" id="L537">                dto.setUpdatedAt(entry.getUpdatedAt());</span>

                // Parser les changes JSON
<span class="fc" id="L540">                List&lt;ReleaseNoteEntryDto.ChangeItem&gt; changes = parseChanges(entry.getChanges());</span>
<span class="fc" id="L541">                dto.setChanges(changes);</span>

<span class="fc" id="L543">                return dto;</span>
        }

        /**
         * Parse les changes JSON en liste de ChangeItem
         */
        private List&lt;ReleaseNoteEntryDto.ChangeItem&gt; parseChanges(String changesJson) {
<span class="pc bpc" id="L550" title="1 of 4 branches missed.">                if (changesJson == null || changesJson.isEmpty()) {</span>
<span class="fc" id="L551">                        return new ArrayList&lt;&gt;();</span>
                }

                try {
<span class="fc" id="L555">                        return objectMapper.readValue(changesJson,</span>
<span class="fc" id="L556">                                        new TypeReference&lt;List&lt;ReleaseNoteEntryDto.ChangeItem&gt;&gt;() {</span>
                                        });
<span class="nc" id="L558">                } catch (JacksonException e) {</span>
<span class="nc" id="L559">                        log.error(&quot;Erreur lors du parsing des changes JSON: {}&quot;, changesJson, e);</span>
<span class="nc" id="L560">                        return new ArrayList&lt;&gt;();</span>
                }
        }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>