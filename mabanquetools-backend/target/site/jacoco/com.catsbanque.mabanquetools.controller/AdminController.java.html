<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdminController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Ma Banque Tools API</a> &gt; <a href="index.source.html" class="el_package">com.catsbanque.mabanquetools.controller</a> &gt; <span class="el_source">AdminController.java</span></div><h1>AdminController.java</h1><pre class="source lang-java linenums">package com.catsbanque.mabanquetools.controller;

import com.catsbanque.mabanquetools.dto.AdminStatsResponse;
import com.catsbanque.mabanquetools.dto.AdminUsersResponse;
import com.catsbanque.mabanquetools.dto.DatabaseExportDto;
import com.catsbanque.mabanquetools.dto.DatabaseImportRequest;
import com.catsbanque.mabanquetools.dto.DeletedUserResponse;
import com.catsbanque.mabanquetools.dto.ImportDatabaseResponse;
import com.catsbanque.mabanquetools.service.AdminService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.http.HttpHeaders;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

import java.time.LocalDate;
import java.time.format.DateTimeFormatter;

/**
 * Contrôleur REST pour l'administration (ADMIN module)
 * Endpoints identiques à Node.js (admin.routes.js)
 * Tous les endpoints nécessitent WRITE sur ADMIN
 */
<span class="fc" id="L32">@Slf4j</span>
@RestController
@RequestMapping(&quot;/admin&quot;)
@RequiredArgsConstructor
public class AdminController {

    private final AdminService adminService;

    /**
     * GET /api/admin/users
     * Récupère la liste de tous les utilisateurs
     * Référence: admin.controller.js:9-36
     */
    @GetMapping(&quot;/users&quot;)
    @PreAuthorize(&quot;@permissionService.hasWriteAccess(principal, T(com.catsbanque.mabanquetools.entity.PermissionModule).ADMIN)&quot;)
    public ResponseEntity&lt;AdminUsersResponse&gt; getAllUsers(org.springframework.security.core.Authentication authentication) {
<span class="nc" id="L48">        log.info(&quot;GET /api/admin/users&quot;);</span>
<span class="nc" id="L49">        AdminUsersResponse response = adminService.getAllUsers();</span>
<span class="nc" id="L50">        return ResponseEntity.ok(response);</span>
    }

    /**
     * DELETE /api/admin/users/:id
     * Supprime un utilisateur
     * Référence: admin.controller.js:44-83
     */
    @DeleteMapping(&quot;/users/{id}&quot;)
    @PreAuthorize(&quot;@permissionService.hasWriteAccess(principal, T(com.catsbanque.mabanquetools.entity.PermissionModule).ADMIN)&quot;)
    public ResponseEntity&lt;DeletedUserResponse&gt; deleteUser(@PathVariable String id, org.springframework.security.core.Authentication authentication) {
<span class="nc" id="L61">        log.info(&quot;DELETE /api/admin/users/{}&quot;, id);</span>
<span class="nc" id="L62">        DeletedUserResponse response = adminService.deleteUser(id);</span>
<span class="nc" id="L63">        return ResponseEntity.ok(response);</span>
    }

    /**
     * GET /api/admin/stats
     * Récupère des statistiques générales
     * Référence: admin.controller.js:89-115
     */
    @GetMapping(&quot;/stats&quot;)
    @PreAuthorize(&quot;@permissionService.hasWriteAccess(principal, T(com.catsbanque.mabanquetools.entity.PermissionModule).ADMIN)&quot;)
    public ResponseEntity&lt;AdminStatsResponse&gt; getStats(org.springframework.security.core.Authentication authentication) {
<span class="nc" id="L74">        log.info(&quot;GET /api/admin/stats&quot;);</span>
<span class="nc" id="L75">        AdminStatsResponse response = adminService.getStats();</span>
<span class="nc" id="L76">        return ResponseEntity.ok(response);</span>
    }

    /**
     * GET /api/admin/export
     * Exporte toute la base de données en JSON
     * Référence: admin.controller.js:121-191
     */
    @GetMapping(&quot;/export&quot;)
    @PreAuthorize(&quot;@permissionService.hasWriteAccess(principal, T(com.catsbanque.mabanquetools.entity.PermissionModule).ADMIN)&quot;)
    public ResponseEntity&lt;DatabaseExportDto&gt; exportDatabase(org.springframework.security.core.Authentication authentication) {
<span class="nc" id="L87">        log.info(&quot;GET /api/admin/export&quot;);</span>
<span class="nc" id="L88">        DatabaseExportDto export = adminService.exportDatabase();</span>

        // Generate filename with current date
<span class="nc" id="L91">        String filename = String.format(</span>
                &quot;ma-banque-tools-backup-%s.json&quot;,
<span class="nc" id="L93">                LocalDate.now().format(DateTimeFormatter.ISO_DATE)</span>
        );

<span class="nc" id="L96">        return ResponseEntity.ok()</span>
<span class="nc" id="L97">                .contentType(MediaType.APPLICATION_JSON)</span>
<span class="nc" id="L98">                .header(HttpHeaders.CONTENT_DISPOSITION, &quot;attachment; filename=\&quot;&quot; + filename + &quot;\&quot;&quot;)</span>
<span class="nc" id="L99">                .body(export);</span>
    }

    /**
     * POST /api/admin/import
     * Importe une base de données depuis un fichier JSON
     * ATTENTION: Écrase toutes les données existantes
     * Référence: admin.controller.js:198-318
     */
    @PostMapping(&quot;/import&quot;)
    @PreAuthorize(&quot;@permissionService.hasWriteAccess(principal, T(com.catsbanque.mabanquetools.entity.PermissionModule).ADMIN)&quot;)
    public ResponseEntity&lt;ImportDatabaseResponse&gt; importDatabase(
            @RequestBody DatabaseImportRequest request,
            org.springframework.security.core.Authentication authentication
    ) {
<span class="nc" id="L114">        log.info(&quot;POST /api/admin/import&quot;);</span>
<span class="nc" id="L115">        ImportDatabaseResponse response = adminService.importDatabase(request);</span>
<span class="nc" id="L116">        return ResponseEntity.ok(response);</span>
    }

    /**
     * POST /api/admin/create-admin-user
     * Crée un utilisateur admin avec l'email &quot;admin&quot; et le mot de passe &quot;admin123&quot;
     * Endpoint utile pour l'initialisation du système
     */
    @PostMapping(&quot;/create-admin-user&quot;)
    @PreAuthorize(&quot;@permissionService.hasWriteAccess(principal, T(com.catsbanque.mabanquetools.entity.PermissionModule).ADMIN)&quot;)
    public ResponseEntity&lt;Void&gt; createAdminUser(org.springframework.security.core.Authentication authentication) {
<span class="nc" id="L127">        log.info(&quot;POST /api/admin/create-admin-user&quot;);</span>
<span class="nc" id="L128">        adminService.createAdminUser();</span>
<span class="nc" id="L129">        return ResponseEntity.noContent().build();</span>

    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.13.202504020838</span></div></body></html>